<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>第五讲 推荐系统-后端开发-推荐篇（下） | 推荐系统开发文档</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/nomoe/favicon.ico">
    <meta name="description" content="News Demo Doc">
    
    <link rel="preload" href="/nomoe/assets/css/0.styles.46c87d11.css" as="style"><link rel="preload" href="/nomoe/assets/js/app.b0634cdc.js" as="script"><link rel="preload" href="/nomoe/assets/js/2.e531c252.js" as="script"><link rel="preload" href="/nomoe/assets/js/25.544fbff6.js" as="script"><link rel="prefetch" href="/nomoe/assets/js/10.f8c2e7ab.js"><link rel="prefetch" href="/nomoe/assets/js/11.a72faa70.js"><link rel="prefetch" href="/nomoe/assets/js/12.2932e2a5.js"><link rel="prefetch" href="/nomoe/assets/js/13.680ff2e4.js"><link rel="prefetch" href="/nomoe/assets/js/14.e1056133.js"><link rel="prefetch" href="/nomoe/assets/js/15.14c6f790.js"><link rel="prefetch" href="/nomoe/assets/js/16.feab6203.js"><link rel="prefetch" href="/nomoe/assets/js/17.da74545f.js"><link rel="prefetch" href="/nomoe/assets/js/18.dfbc94c1.js"><link rel="prefetch" href="/nomoe/assets/js/19.5e254fde.js"><link rel="prefetch" href="/nomoe/assets/js/20.f8be3a04.js"><link rel="prefetch" href="/nomoe/assets/js/21.83956418.js"><link rel="prefetch" href="/nomoe/assets/js/22.d0011416.js"><link rel="prefetch" href="/nomoe/assets/js/23.e1c4e5da.js"><link rel="prefetch" href="/nomoe/assets/js/24.52c6dafe.js"><link rel="prefetch" href="/nomoe/assets/js/26.5fd376d5.js"><link rel="prefetch" href="/nomoe/assets/js/27.4a83da68.js"><link rel="prefetch" href="/nomoe/assets/js/3.b79a0801.js"><link rel="prefetch" href="/nomoe/assets/js/4.21c265ed.js"><link rel="prefetch" href="/nomoe/assets/js/5.67bfa7f8.js"><link rel="prefetch" href="/nomoe/assets/js/6.c01f87cc.js"><link rel="prefetch" href="/nomoe/assets/js/7.ea71c5c9.js"><link rel="prefetch" href="/nomoe/assets/js/8.f6d4234c.js"><link rel="prefetch" href="/nomoe/assets/js/9.906cc110.js">
    <link rel="stylesheet" href="/nomoe/assets/css/0.styles.46c87d11.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/nomoe/" class="home-link router-link-active"><img src="/nomoe/logo.gif" alt="推荐系统开发文档" class="logo"> <span class="site-name can-hide">推荐系统开发文档</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/nomoe/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="推荐系统开发" class="dropdown-title"><span class="title">推荐系统开发</span> <span class="arrow down"></span></button> <button type="button" aria-label="推荐系统开发" class="mobile-dropdown-title"><span class="title">推荐系统开发</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/nomoe/develop/01/" class="nav-link">
  第一讲
</a></li><li class="dropdown-item"><!----> <a href="/nomoe/develop/02/" class="nav-link">
  第二讲
</a></li><li class="dropdown-item"><!----> <a href="/nomoe/develop/03/" class="nav-link">
  第三讲
</a></li><li class="dropdown-item"><!----> <a href="/nomoe/develop/04/" class="nav-link">
  第四讲
</a></li><li class="dropdown-item"><!----> <a href="/nomoe/develop/05/" class="nav-link router-link-active">
  第五讲
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/nomoe/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="推荐系统开发" class="dropdown-title"><span class="title">推荐系统开发</span> <span class="arrow down"></span></button> <button type="button" aria-label="推荐系统开发" class="mobile-dropdown-title"><span class="title">推荐系统开发</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/nomoe/develop/01/" class="nav-link">
  第一讲
</a></li><li class="dropdown-item"><!----> <a href="/nomoe/develop/02/" class="nav-link">
  第二讲
</a></li><li class="dropdown-item"><!----> <a href="/nomoe/develop/03/" class="nav-link">
  第三讲
</a></li><li class="dropdown-item"><!----> <a href="/nomoe/develop/04/" class="nav-link">
  第四讲
</a></li><li class="dropdown-item"><!----> <a href="/nomoe/develop/05/" class="nav-link router-link-active">
  第五讲
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/nomoe/develop/05/" aria-current="page" class="sidebar-link">第五讲 推荐系统 前言</a></li><li><a href="/nomoe/develop/05/user.html" class="sidebar-link">第五讲 推荐系统-后端开发-用户篇</a></li><li><a href="/nomoe/develop/05/rec-01.html" class="sidebar-link">第五讲 推荐系统-后端开发-推荐篇（上）</a></li><li><a href="/nomoe/develop/05/rec-02.html" aria-current="page" class="active sidebar-link">第五讲 推荐系统-后端开发-推荐篇（下）</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/nomoe/develop/05/rec-02.html#前言" class="sidebar-link">前言</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/nomoe/develop/05/rec-02.html#新闻推荐评分表" class="sidebar-link">新闻推荐评分表</a></li></ul></li><li class="sidebar-sub-header"><a href="/nomoe/develop/05/rec-02.html#_1、相似用户" class="sidebar-link">1、相似用户</a></li><li class="sidebar-sub-header"><a href="/nomoe/develop/05/rec-02.html#_2、基于用户的协同过滤推荐" class="sidebar-link">2、基于用户的协同过滤推荐</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/nomoe/develop/05/rec-02.html#_1、分析" class="sidebar-link">1、分析</a></li><li class="sidebar-sub-header"><a href="/nomoe/develop/05/rec-02.html#_2、实践" class="sidebar-link">2、实践</a></li><li class="sidebar-sub-header"><a href="/nomoe/develop/05/rec-02.html#_3、测试" class="sidebar-link">3、测试</a></li></ul></li><li class="sidebar-sub-header"><a href="/nomoe/develop/05/rec-02.html#_3、基于物品的协同过滤推荐" class="sidebar-link">3、基于物品的协同过滤推荐</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/nomoe/develop/05/rec-02.html#_1、分析-2" class="sidebar-link">1、分析</a></li></ul></li><li class="sidebar-sub-header"><a href="/nomoe/develop/05/rec-02.html#_4、总结" class="sidebar-link">4、总结</a></li></ul></li><li><a href="/nomoe/develop/05/front.html" class="sidebar-link">第五讲 推荐系统-前端开发</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="第五讲-推荐系统-后端开发-推荐篇-下"><a href="#第五讲-推荐系统-后端开发-推荐篇-下" class="header-anchor">#</a> 第五讲 推荐系统-后端开发-推荐篇（下）</h1> <hr> <h2 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h2> <p>先看看新闻推荐评分表</p> <h3 id="新闻推荐评分表"><a href="#新闻推荐评分表" class="header-anchor">#</a> 新闻推荐评分表</h3> <table><thead><tr><th>编号</th> <th>项目</th> <th>分值</th></tr></thead> <tbody><tr><td>T1</td> <td>随机推荐</td> <td>1</td></tr> <tr><td>T2</td> <td>基于内容的推荐，基于当前新闻</td> <td>1</td></tr> <tr><td>T3</td> <td>基于内容的推荐，基于用户偏好</td> <td>1</td></tr> <tr><td>T4</td> <td>用户登录</td> <td>1</td></tr> <tr><td>T5</td> <td>用户浏览记录</td> <td>1</td></tr> <tr><td>T6</td> <td>相似用户</td> <td>1</td></tr> <tr><td>T7</td> <td>基于用户的协同过滤推荐</td> <td>1</td></tr> <tr><td>T8</td> <td>基于物品的协同过滤推荐</td> <td>1</td></tr> <tr><td></td> <td>总分</td> <td>8</td></tr></tbody></table> <p>当然啦，这张表里面的我们只差T6、T7、T8，其他的在上篇已经完成，接下来把剩下的完成吧</p> <h2 id="_1、相似用户"><a href="#_1、相似用户" class="header-anchor">#</a> 1、相似用户</h2> <p>这部分在基于用户的协同过滤里面会顺带实现</p> <h2 id="_2、基于用户的协同过滤推荐"><a href="#_2、基于用户的协同过滤推荐" class="header-anchor">#</a> 2、基于用户的协同过滤推荐</h2> <h3 id="_1、分析"><a href="#_1、分析" class="header-anchor">#</a> 1、分析</h3> <p>基于用户的协同过滤推荐，首先，我们根据所有用户的评分记录，形成评分矩阵，然后计算出最相似的K个相似用户，再获取这K个相似用户的评分最高的新闻，去掉用户浏览过的，最后推荐给用户</p> <h3 id="_2、实践"><a href="#_2、实践" class="header-anchor">#</a> 2、实践</h3> <p>在 <code>NewsService</code> 下新建方法，这里提前预告一下，由于基于用户的协同过滤推荐已经计算出相似用户，因此，我们的返回类型要改为Map，一个是相似用户，一个是推荐的新闻</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 根据用户找出相似用户和推荐新闻
 *
 * @param userId 用户id
 * @return 推荐的新闻和相似用户
 */</span>
<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">recommendByUser</span><span class="token punctuation">(</span><span class="token class-name">Long</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>然后在实现类里面写逻辑</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 根据用户找出相似用户和推荐新闻
 *
 * @param userId 用户id
 * @return 推荐的新闻和相似用户
 */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">recommendByUser</span><span class="token punctuation">(</span><span class="token class-name">Long</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 编写逻辑...</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>首先是获取所有用户的评分列表</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 1.获取所有用户评分记录</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">NewsRate</span><span class="token punctuation">&gt;</span></span> userRateList <span class="token operator">=</span> newsRateMapper<span class="token punctuation">.</span><span class="token function">selectAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>然后要根据评分记录生成用户评分矩阵，一个用户id对应一个他们的新闻评分表，因此我们可以采取哈希表来存储，然后新闻评分表也是一个哈希表，键是新闻id，值是评分。所以用户评分矩阵的键是用户id，值是用户的评分表，为了提高代码可读性，为此我们需要增加一个类<code>UserRateMap</code>：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>entity</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashMap</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Getter</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token annotation punctuation">@ToString</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserRateMap</span> <span class="token punctuation">{</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> userRateMap<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setScores</span><span class="token punctuation">(</span><span class="token class-name">Long</span> articleId<span class="token punctuation">,</span> <span class="token class-name">Integer</span> score<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>userRateMap <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>userRateMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>userRateMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>articleId<span class="token punctuation">,</span> score<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>继续编写逻辑，可能有的童鞋有疑惑，这个 <code>newsRate.getInterest() * 2 + newsRate.getQuality()</code> 干嘛的？其实这个是计算评分的一种加权写法，这里兴趣分乘以2，原因是我认为兴趣分应该相对于质量分占更高的比重，所以在计算的时候我们可以给适当加权</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 2.按用户id统计浏览评分，形成用户评分矩阵</span>
<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">UserRateMap</span><span class="token punctuation">&gt;</span></span> userRateMatrix <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 遍历评分记录</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">NewsRate</span> newsRate <span class="token operator">:</span> userRateList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 从评分矩阵中获取用户的评分表</span>
  <span class="token class-name">UserRateMap</span> userRate <span class="token operator">=</span> userRateMatrix<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>newsRate<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 如果有</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>userRate <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 增加一篇新闻的评分</span>
    userRate<span class="token punctuation">.</span><span class="token function">setScores</span><span class="token punctuation">(</span>newsRate<span class="token punctuation">.</span><span class="token function">getArticleId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> newsRate<span class="token punctuation">.</span><span class="token function">getInterest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> newsRate<span class="token punctuation">.</span><span class="token function">getQuality</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 新建评分表</span>
    <span class="token class-name">UserRateMap</span> userRateMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserRateMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    userRateMap<span class="token punctuation">.</span><span class="token function">setScores</span><span class="token punctuation">(</span>newsRate<span class="token punctuation">.</span><span class="token function">getArticleId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> newsRate<span class="token punctuation">.</span><span class="token function">getInterest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> newsRate<span class="token punctuation">.</span><span class="token function">getQuality</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    userRateMatrix<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>newsRate<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> userRateMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>现在可以通过 <code>userRateMatrix.get(用户id)</code> 获取用户的评分表了，然后还有个细节，如果用户一条评分记录都没有怎么办呢，这个问题其实上篇中的根据用户最近评分的新闻推荐也会遇到这个问题，不过我还是到这里再提出这个问题，那个问题留给大家当做练习改进吧。其实也挺简单的，如果用户没有评分记录的话我们就直接随机推荐就行，因此可以这样写</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 如果用户还没浏览过新闻则随机推荐新闻</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>viewMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// 返回随机推荐结果</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>不过返回随机推荐结果的逻辑我们先空着，后面会对返回结果统一封装，接下来编写计算用户和其他用户的相似度</p> <p>那么，该如何计算相似度呢？</p> <p>首先我们要把当前用户的评分表单独拿出来，然后从矩阵里面把当前用户的评分表删除掉</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 把当前用户的评分表单独拿出来，在评分矩阵中剔除掉当前用户的</span>
<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> currentUserRateMap <span class="token operator">=</span> userRateMatrix<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getUserRateMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
userRateMatrix<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>然后遍历评分矩阵，计算其他用户和用户的相似度</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 用户与其他用户的余弦相似度表</span>
<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Double</span><span class="token punctuation">&gt;</span></span> userCOSMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">UserRateMap</span><span class="token punctuation">&gt;</span></span> userRateMap<span class="token operator">:</span> userRateMatrix<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 计算当前用户和其他用户的余弦相似度</span>
  <span class="token keyword">double</span> cos <span class="token operator">=</span> <span class="token function">calculateCOS</span><span class="token punctuation">(</span>currentUserRateMap<span class="token punctuation">,</span> userRateMap<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getUserRateMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 存放与当前用户比较的其他用户的id以及对应的余弦相似度</span>
  userCOSMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>userRateMap<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cos<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>有了相似度，接下来就是根据相似度找出最相似的K个用户了</p> <p>首先要对这些相似度从高到低排序，下面是排序的方法</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Double</span><span class="token punctuation">&gt;</span></span> <span class="token function">sortCOSMap</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Double</span><span class="token punctuation">&gt;</span></span> userCOSMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Double</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token class-name">CommonUtil</span><span class="token punctuation">.</span><span class="token function">sortMap</span><span class="token punctuation">(</span>userCOSMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Double</span><span class="token punctuation">&gt;</span></span> newMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Double</span><span class="token punctuation">&gt;</span></span> entry <span class="token operator">:</span> list<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        newMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> newMap<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>然后编写逻辑</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 准备用户列表</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> similarUserList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 要挑选的最相似用户数量K</span>
<span class="token keyword">int</span> <span class="token class-name">K</span> <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
<span class="token comment">// 对用户相似度排序</span>
<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Double</span><span class="token punctuation">&gt;</span></span> sortedCOSMap <span class="token operator">=</span> <span class="token function">sortCOSMap</span><span class="token punctuation">(</span>userCOSMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 如果相似用户数量不足5的话则取最小值</span>
<span class="token keyword">int</span> userNumber <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>sortedCOSMap<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">K</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Double</span><span class="token punctuation">&gt;</span></span> entry<span class="token operator">:</span> sortedCOSMap<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>userNumber<span class="token operator">--</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        similarUserList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>userService<span class="token punctuation">.</span><span class="token function">findUserByUserId</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>这里同样需要注意相似用户数量不足5个的问题，请大家注意，不足5个的话我们就取最小值</p> <p>由于<code>UserMapper</code>，<code>UserService</code>没有提供根据id查询的方法 <code>findUserByUserId</code>，所以我们得补上：</p> <p><code>UserMapper</code>：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 根据用户id查询用户信息
 *
 * @param id 用户id
 * @return 用户信息
 */</span>
<span class="token annotation punctuation">@Select</span><span class="token punctuation">(</span><span class="token string">&quot;select * from user where id = #{id}&quot;</span><span class="token punctuation">)</span>
<span class="token class-name">User</span> <span class="token function">findUserByUserId</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token keyword">long</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><code>UserService</code>：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 根据用户id查询用户信息
 *
 * @param id 用户id
 * @return 用户信息
 */</span>
<span class="token class-name">User</span> <span class="token function">findUserByUserId</span><span class="token punctuation">(</span><span class="token keyword">long</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>实现类：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">User</span> <span class="token function">findUserByUserId</span><span class="token punctuation">(</span><span class="token keyword">long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> userMapper<span class="token punctuation">.</span><span class="token function">findUserByUserId</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>到这里K个最相似用户就筛选出来了，接下来要根据K个相似用户进行筛选新闻</p> <p>总体思路是选出他们每个人评分最高的新闻至多10篇，然后再选择前10篇</p> <p>首先准备一个存放新闻id和新闻最终评分的表，该表就是候选新闻列表</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 定义候选新闻表</span>
<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Double</span><span class="token punctuation">&gt;</span></span> candidateMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>接下来根据每个用户评分过的新闻评分计算新闻权重</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Double</span><span class="token punctuation">&gt;</span></span> entry<span class="token operator">:</span> sortedCOSMap<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>首先获取用户评分表</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> userRateMap <span class="token operator">=</span> userRateMatrix<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getUserRateMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>然后需要过滤评分表里评分为0的项，因为评分为0的在排序的时候会引起异常</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 过滤权重为0的新闻</span>
<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Double</span><span class="token punctuation">&gt;</span></span> newUserRateMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
userRateMap<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> v<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>v <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        newUserRateMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> <span class="token class-name">Double</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>然后就是根据新闻评分排序了</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 根据新闻权重进行排序</span>
<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Double</span><span class="token punctuation">&gt;</span></span> sortedCosMap <span class="token operator">=</span> <span class="token function">sortCOSMap</span><span class="token punctuation">(</span>newUserRateMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Double</span><span class="token punctuation">&gt;</span></span> sortedCos <span class="token operator">:</span> sortedCosMap<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>candidateMap<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">10</span> <span class="token operator">*</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token class-name">Long</span> newsId <span class="token operator">=</span> sortedCos<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 用户没评分过的文章</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>currentUserRateMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>newsId<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 候选集里面没有</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>candidateMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>newsId<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      candidateMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>newsId<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 候选集里面有，则说明这篇文章大家都喜欢，应该增加权重</span>
      candidateMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>newsId<span class="token punctuation">,</span> candidateMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>newsId<span class="token punctuation">)</span> <span class="token operator">+</span>
                       <span class="token comment">// 用户相似度 × 新闻评分 = 最终新闻权重</span>
                       userCOSMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> sortedCos<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>对于一下这段代码有的童鞋可能比较疑惑，其实这段代码的作用是每次选够十条放到候选集就可以终止</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>candidateMap<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">10</span> <span class="token operator">*</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>完整代码</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 计算</span>
<span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Double</span><span class="token punctuation">&gt;</span></span> entry<span class="token operator">:</span> sortedCOSMap<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> userRateMap <span class="token operator">=</span> userRateMatrix<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getUserRateMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 过滤权重为0的新闻</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Double</span><span class="token punctuation">&gt;</span></span> newUserRateMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    userRateMap<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> v<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>v <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            newUserRateMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> <span class="token class-name">Double</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 根据新闻权重进行排序</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Double</span><span class="token punctuation">&gt;</span></span> sortedCosMap <span class="token operator">=</span> <span class="token function">sortCOSMap</span><span class="token punctuation">(</span>newUserRateMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 遍历sortedCosMap，挑出用户没评分过的文章，加入到候选集</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Double</span><span class="token punctuation">&gt;</span></span> sortedCos <span class="token operator">:</span> sortedCosMap<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>candidateMap<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">10</span> <span class="token operator">*</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">Long</span> newsId <span class="token operator">=</span> sortedCos<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 用户没评分过的文章</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>currentUserRateMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>newsId<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 候选集里面没有</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>candidateMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>newsId<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                candidateMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>newsId<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// 候选集里面有，则说明这篇文章大家都喜欢，应该增加权重</span>
                candidateMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>newsId<span class="token punctuation">,</span> candidateMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>newsId<span class="token punctuation">)</span> <span class="token operator">+</span>
                        <span class="token comment">// 用户相似度 × 新闻评分 = 最终新闻权重</span>
                        userCOSMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> sortedCos<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    i<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><p>接下来对候选集排序，还是用那个排序方法即可</p> <p>然后就可以回数据库查询最终结果了</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 对候选集排序</span>
<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Double</span><span class="token punctuation">&gt;</span></span> sortedCandidateNews <span class="token operator">=</span> <span class="token function">sortCOSMap</span><span class="token punctuation">(</span>candidateMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 回数据库查询最终的推荐新闻</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">News</span><span class="token punctuation">&gt;</span></span> resultNews <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Double</span><span class="token punctuation">&gt;</span></span> entry<span class="token operator">:</span> sortedCandidateNews<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>n<span class="token operator">++</span> <span class="token operator">&gt;</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">Long</span> newsId <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    resultNews<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>newsMapper<span class="token punctuation">.</span><span class="token function">selectNewsById</span><span class="token punctuation">(</span>newsId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>对于返回结果的封装，我们需要封装相似用户和推荐的新闻</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">generateResultMap</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">News</span><span class="token punctuation">&gt;</span></span> newsList<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> userList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> resultMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    resultMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;list&quot;</span><span class="token punctuation">,</span> newsList<span class="token punctuation">)</span><span class="token punctuation">;</span>
    resultMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;similarUsers&quot;</span><span class="token punctuation">,</span> userList<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> resultMap<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>然后调用即可</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token class-name">Message</span><span class="token punctuation">.</span>SUCCESS<span class="token punctuation">,</span> <span class="token class-name">Message</span><span class="token punctuation">.</span>SUCCESS_MESSAGE<span class="token punctuation">,</span> resultMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>随机推荐的</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 如果用户还没浏览过新闻则随机推荐新闻</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>userRateMatrix<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">generateResultMap</span><span class="token punctuation">(</span><span class="token function">selectNewsByRandom</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>然后 <code>NewsApi</code> 增加接口，调用即可</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 根据用户协同过滤推荐新闻和相似用户
 *
 * @param userInfo 用户信息
 * @return 推荐的新闻
 */</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/recByUser&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@RequireToken</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">recommendByUser</span><span class="token punctuation">(</span><span class="token annotation punctuation">@UserInfo</span> <span class="token class-name">User</span> userInfo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token class-name">Message</span><span class="token punctuation">.</span>SUCCESS<span class="token punctuation">,</span> <span class="token class-name">Message</span><span class="token punctuation">.</span>SUCCESS_MESSAGE<span class="token punctuation">,</span> newsService<span class="token punctuation">.</span><span class="token function">recommendByUser</span><span class="token punctuation">(</span>userInfo<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="_3、测试"><a href="#_3、测试" class="header-anchor">#</a> 3、测试</h3> <p>http://localhost:8080/api/news/recByUser
<img src="https://img-blog.csdnimg.cn/bec92352458b44efafbcdead7591a8ed.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L20wXzQ2NDkxNTQ5,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p> <p>OK，到这里基于用户协同过滤推荐就开发完了</p> <h2 id="_3、基于物品的协同过滤推荐"><a href="#_3、基于物品的协同过滤推荐" class="header-anchor">#</a> 3、基于物品的协同过滤推荐</h2> <h3 id="_1、分析-2"><a href="#_1、分析-2" class="header-anchor">#</a> 1、分析</h3> <p>基于物品的协同过滤推荐，在这里我不打算实现，因为我认为对于100多万篇新闻，确定两两的相似度，几乎是不可能的，而且如果需要测试效果，需要大量的测试数据，少量数据根本测试不出效果，因此我不打算实现该功能~ 请大家谅解和自行解决~</p> <h2 id="_4、总结"><a href="#_4、总结" class="header-anchor">#</a> 4、总结</h2> <p>OK，到这里新闻的后端开发就基本上完成了，当然，在项目中还存在值得优化的地方，比如错误页面的定制等，不过，那些细节都交由你们完善，我不可能做到面面俱到，还请大家谅解~ 觉得本教程不错的童鞋不要吝啬，多多分享哦！祝大家都能顺利完成该项目~</p> <p><img src="https://img-blog.csdnimg.cn/b4c892daf7144ded9857ab3c755c1373.gif" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-6MO4covG-1628153979055)(5_推荐系统_后端开发_2推荐篇（下）.assets/048E847A.gif)]"></p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/nomoe/develop/05/rec-01.html" class="prev">
        第五讲 推荐系统-后端开发-推荐篇（上）
      </a></span> <span class="next"><a href="/nomoe/develop/05/front.html">
        第五讲 推荐系统-前端开发
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/nomoe/assets/js/app.b0634cdc.js" defer></script><script src="/nomoe/assets/js/2.e531c252.js" defer></script><script src="/nomoe/assets/js/25.544fbff6.js" defer></script>
  </body>
</html>
