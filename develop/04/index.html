<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>第四讲 检索模型 | 推荐系统开发文档</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/nomoe/favicon.ico">
    <meta name="description" content="News Demo Doc">
    
    <link rel="preload" href="/nomoe/assets/css/0.styles.46c87d11.css" as="style"><link rel="preload" href="/nomoe/assets/js/app.b0634cdc.js" as="script"><link rel="preload" href="/nomoe/assets/js/2.e531c252.js" as="script"><link rel="preload" href="/nomoe/assets/js/18.dfbc94c1.js" as="script"><link rel="prefetch" href="/nomoe/assets/js/10.f8c2e7ab.js"><link rel="prefetch" href="/nomoe/assets/js/11.a72faa70.js"><link rel="prefetch" href="/nomoe/assets/js/12.2932e2a5.js"><link rel="prefetch" href="/nomoe/assets/js/13.680ff2e4.js"><link rel="prefetch" href="/nomoe/assets/js/14.e1056133.js"><link rel="prefetch" href="/nomoe/assets/js/15.14c6f790.js"><link rel="prefetch" href="/nomoe/assets/js/16.feab6203.js"><link rel="prefetch" href="/nomoe/assets/js/17.da74545f.js"><link rel="prefetch" href="/nomoe/assets/js/19.5e254fde.js"><link rel="prefetch" href="/nomoe/assets/js/20.f8be3a04.js"><link rel="prefetch" href="/nomoe/assets/js/21.83956418.js"><link rel="prefetch" href="/nomoe/assets/js/22.d0011416.js"><link rel="prefetch" href="/nomoe/assets/js/23.e1c4e5da.js"><link rel="prefetch" href="/nomoe/assets/js/24.52c6dafe.js"><link rel="prefetch" href="/nomoe/assets/js/25.544fbff6.js"><link rel="prefetch" href="/nomoe/assets/js/26.5fd376d5.js"><link rel="prefetch" href="/nomoe/assets/js/27.4a83da68.js"><link rel="prefetch" href="/nomoe/assets/js/3.b79a0801.js"><link rel="prefetch" href="/nomoe/assets/js/4.21c265ed.js"><link rel="prefetch" href="/nomoe/assets/js/5.67bfa7f8.js"><link rel="prefetch" href="/nomoe/assets/js/6.c01f87cc.js"><link rel="prefetch" href="/nomoe/assets/js/7.ea71c5c9.js"><link rel="prefetch" href="/nomoe/assets/js/8.f6d4234c.js"><link rel="prefetch" href="/nomoe/assets/js/9.906cc110.js">
    <link rel="stylesheet" href="/nomoe/assets/css/0.styles.46c87d11.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/nomoe/" class="home-link router-link-active"><img src="/nomoe/logo.gif" alt="推荐系统开发文档" class="logo"> <span class="site-name can-hide">推荐系统开发文档</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/nomoe/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="推荐系统开发" class="dropdown-title"><span class="title">推荐系统开发</span> <span class="arrow down"></span></button> <button type="button" aria-label="推荐系统开发" class="mobile-dropdown-title"><span class="title">推荐系统开发</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/nomoe/develop/01/" class="nav-link">
  第一讲
</a></li><li class="dropdown-item"><!----> <a href="/nomoe/develop/02/" class="nav-link">
  第二讲
</a></li><li class="dropdown-item"><!----> <a href="/nomoe/develop/03/" class="nav-link">
  第三讲
</a></li><li class="dropdown-item"><!----> <a href="/nomoe/develop/04/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  第四讲
</a></li><li class="dropdown-item"><!----> <a href="/nomoe/develop/05/" class="nav-link">
  第五讲
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/nomoe/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="推荐系统开发" class="dropdown-title"><span class="title">推荐系统开发</span> <span class="arrow down"></span></button> <button type="button" aria-label="推荐系统开发" class="mobile-dropdown-title"><span class="title">推荐系统开发</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/nomoe/develop/01/" class="nav-link">
  第一讲
</a></li><li class="dropdown-item"><!----> <a href="/nomoe/develop/02/" class="nav-link">
  第二讲
</a></li><li class="dropdown-item"><!----> <a href="/nomoe/develop/03/" class="nav-link">
  第三讲
</a></li><li class="dropdown-item"><!----> <a href="/nomoe/develop/04/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  第四讲
</a></li><li class="dropdown-item"><!----> <a href="/nomoe/develop/05/" class="nav-link">
  第五讲
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/nomoe/develop/04/" aria-current="page" class="active sidebar-link">第四讲 检索模型</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/nomoe/develop/04/#_1、计算和导入-tfidf-和-bayes" class="sidebar-link">1、计算和导入 tfidf 和 bayes</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/nomoe/develop/04/#_1、修改-article-word-表为-article-word-origin" class="sidebar-link">1、修改 article_word 表为 article_word_origin</a></li><li class="sidebar-sub-header"><a href="/nomoe/develop/04/#_2、思考" class="sidebar-link">2、思考</a></li><li class="sidebar-sub-header"><a href="/nomoe/develop/04/#_3、vocabulary和vocabulary2的生成算法" class="sidebar-link">3、vocabulary和vocabulary2的生成算法</a></li><li class="sidebar-sub-header"><a href="/nomoe/develop/04/#_4、生成两个表" class="sidebar-link">4、生成两个表</a></li><li class="sidebar-sub-header"><a href="/nomoe/develop/04/#_5、导入article-word" class="sidebar-link">5、导入article_word</a></li></ul></li><li class="sidebar-sub-header"><a href="/nomoe/develop/04/#_2、更新-newsdemoweb-项目" class="sidebar-link">2、更新 NewsDemoWeb 项目</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/nomoe/develop/04/#_1、分析查询语句" class="sidebar-link">1、分析查询语句</a></li><li class="sidebar-sub-header"><a href="/nomoe/develop/04/#_2、编写dao" class="sidebar-link">2、编写DAO</a></li></ul></li><li class="sidebar-sub-header"><a href="/nomoe/develop/04/#_3、开发分页" class="sidebar-link">3、开发分页</a></li></ul></li><li><a href="/nomoe/develop/04/jquery.html" class="sidebar-link">第四讲 检索模型-前端开发-jQuery版</a></li><li><a href="/nomoe/develop/04/vue.html" class="sidebar-link">第四讲 检索模型-前端开发-Vue基础版</a></li><li><a href="/nomoe/develop/04/vue-cli.html" class="sidebar-link">第四讲 检索模型-前端开发-Vue高阶版</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="第四讲-检索模型"><a href="#第四讲-检索模型" class="header-anchor">#</a> 第四讲 检索模型</h1> <hr> <h2 id="_1、计算和导入-tfidf-和-bayes"><a href="#_1、计算和导入-tfidf-和-bayes" class="header-anchor">#</a> 1、计算和导入 <code>tfidf</code> 和 <code>bayes</code></h2> <h3 id="_1、修改-article-word-表为-article-word-origin"><a href="#_1、修改-article-word-表为-article-word-origin" class="header-anchor">#</a> 1、修改 <code>article_word</code> 表为 <code>article_word_origin</code></h3> <p>原来的 <code>article_word</code> 里没有 <code>tfidf</code> 和 <code>bayes</code> 字段，但我不想直接修改表，所以把原来的 <code>article_word</code> 表名修改为 <code>article_word_origin</code>， 代表“源”的意思（现在开始下面凡是提到 <code>article_word_origin</code> 都指的是老的 <code>article_word</code>，<code>article_word</code>指的是新的，请注意区分）然后新建有 <code>tfidf</code> 和 <code>bayes</code> 字段的表：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>article_word_origin<span class="token punctuation">`</span> <span class="token punctuation">(</span>
	<span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token punctuation">(</span> <span class="token number">20</span> <span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
	<span class="token punctuation">`</span>article_id<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span> <span class="token punctuation">(</span> <span class="token number">20</span> <span class="token punctuation">)</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
	<span class="token punctuation">`</span>word<span class="token punctuation">`</span> <span class="token keyword">VARCHAR</span> <span class="token punctuation">(</span> <span class="token number">240</span> <span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> 
	<span class="token keyword">SET</span> utf8 <span class="token keyword">COLLATE</span> utf8_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
	<span class="token punctuation">`</span>freqs<span class="token punctuation">`</span> <span class="token keyword">INT</span> <span class="token punctuation">(</span> <span class="token number">11</span> <span class="token punctuation">)</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
	<span class="token punctuation">`</span>freqs_title<span class="token punctuation">`</span> <span class="token keyword">INT</span> <span class="token punctuation">(</span> <span class="token number">11</span> <span class="token punctuation">)</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
	<span class="token punctuation">`</span>freqs_content<span class="token punctuation">`</span> <span class="token keyword">INT</span> <span class="token punctuation">(</span> <span class="token number">11</span> <span class="token punctuation">)</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
	<span class="token punctuation">`</span>tfidf<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span> <span class="token punctuation">(</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">10</span> <span class="token punctuation">)</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
	<span class="token punctuation">`</span>bayes<span class="token punctuation">`</span> <span class="token keyword">DECIMAL</span> <span class="token punctuation">(</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">10</span> <span class="token punctuation">)</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
	<span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span> <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> MyISAM <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> <span class="token operator">=</span> utf8<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>疑问：为什么不直接更新表，增加两个字段，然后采用更新的方式插入这两个字段？</p> <p>回答：因为表里面有1亿多条数据，直接更新的话会非常缓慢，不信你试试，，所以我们还是采取读文件的方式，遍历每一篇新闻，分词和计算 <code>tfidf</code>，<code>bayes</code>后再插入到数据库，读文件永远滴神
<img src="https://img-blog.csdnimg.cn/c25efd76e7114b1daa6b97c1b2fa4ab4.gif" alt="在这里插入图片描述" style="zoom:80%;"></p> <h3 id="_2、思考"><a href="#_2、思考" class="header-anchor">#</a> 2、思考</h3> <p>首先观察 <code>tfidf</code> 公式：</p> <img src="https://img-blog.csdnimg.cn/5603d955eb9040fe803b6f628939b19a.png" alt="在这里插入图片描述" style="zoom:80%;"> <ul><li><code>count(w, d)</code> 代表的是词汇在当前文章出现的次数</li> <li><code>k, b</code>两个参数已经固定为<code>10</code> 和 <code>0.5</code></li> <li><code>|d|</code> 是当前文档长度</li> <li><code>avgd</code> 是平均文档长度</li> <li><code>|D|</code> 是文档总数</li> <li><code>count(w, D)</code> 包含该词 word 的文档数，即词汇在整个新闻集合中出现的新闻篇数，虽然一篇新闻包含多个该词汇，但它的值也只为1</li></ul> <p>然后观察 <code>bayes</code> 公式：</p> <img src="https://img-blog.csdnimg.cn/ae36d1ec9f5c4bfcb62a9f8f9561ee39.png" alt="在这里插入图片描述" style="zoom:80%;"> <ul><li><code>c(w, d)</code> 代表的是词汇在当前文章出现的次数</li> <li><code>μ</code> 参数固定为<code>2000</code></li> <li><code>|d|</code> 是当前文档长度</li> <li><code>|D|</code> 是文档<strong>总词汇数</strong></li> <li><code>c(w, D)</code> 是词汇 w 在文档集中出现的次数，即词汇在整个新闻集合中出现的总次数</li></ul> <p>对于计算 <code>tfidf</code> 而言，我们在遍历每一篇新闻的时候，最后一个参数 <code>count(w, D)</code> 获取起来比较麻烦，如果想获得最后一个参数 <code>count(w, D)</code>，必须每次都查询数据库，执行以下语句</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> <span class="token punctuation">`</span>article_word_origin<span class="token punctuation">`</span> <span class="token keyword">where</span> word <span class="token operator">=</span> <span class="token string">'美女'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>但是仔细想想这是不可取的，因为这要查询N次数据库，效率极低，速度很慢，所以我们可以投机取巧，那么怎么投机取巧呢
<img src="https://img-blog.csdnimg.cn/9782865b81f34fc8b136e8e4b579045a.jpg" alt="在这里插入图片描述" style="zoom:80%;"></p> <p>我们可以先把它算好，然后放在一张数据库表里面，然后到时候先把表加载到内存，想要哪个字段的<code>count(w, D)</code> 就直接查表即可，当然这里的表数据结构指的是哈希Map，键存单词，值存 <code>count(w, D)</code>，怎么样，是不是挺秒~</p> <p>所以这也是我们创建 <code>vocabulary2</code> 表的原因，当然啦，有人会问 <code>vocabulary</code> 不能用吗，回答是当然不能！</p> <p>因为， <code>vocabulary</code> 存储的是词汇出现的总数，而 <code>vocabulary</code>2 存储的是词汇出现的文章篇数，两者性质不一样，千万别搞混了，<code>vocabulary</code> 表是给计算贝叶斯的 <code>c(w, D)</code> 用的。</p> <p>此外，之前创建过 <code>temp</code> 表， <code>temp</code> 表是干嘛的，<code>temp</code> 是给生成 <code>vocabulary</code> 和 <code>vocabulary2</code> 表时作为临时表的~</p> <h3 id="_3、vocabulary和vocabulary2的生成算法"><a href="#_3、vocabulary和vocabulary2的生成算法" class="header-anchor">#</a> 3、<code>vocabulary</code>和<code>vocabulary2</code>的生成算法</h3> <p>接下来讨论怎么生成 <code>vocabulary</code>，其实也挺简单的，就是读取 <code>article_word_origin</code> 的 <code>word</code> 和 <code>freqs</code>，分别作为哈希表的键和值，遍历结果集，如果遇到重复的键则把值相加，然后再写入到<code>vocabulary</code> 。简单理解就是去掉重复的键，把它们的值加起来。</p> <p>伪代码：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 读取词汇, 词汇在某篇新闻中的频次</span>
select word<span class="token punctuation">,</span> freqs from article_word_origin
<span class="token comment">// 遍历结果集</span>
<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>哈希表包含当前词汇<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 获取已有频次</span>
    frequency <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>word<span class="token punctuation">)</span>
    <span class="token comment">// 增加当前频次</span>
    map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>word<span class="token punctuation">,</span> frequency <span class="token operator">+</span> freqs<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果不包含则新建</span>
    map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>word<span class="token punctuation">,</span> freqs<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>其实就是这么简单，但是实现起来会有一些问题。</p> <p>首先， <code>article_word_origin</code> 有1亿多条数据，直接扔个 <code>select word, freqs from article_word_origin</code> 肯定是不可取的，因为内存根本顶不住，当然啦，如果你的电脑内存 <code>128G</code> 当我没说，但是对于大多数电脑而言，我们还是分批次处理比较稳妥，比如一次处理个一千万，实测速度还行，大家自己根据的机器配置斟酌。既然我们选择分批次处理，就得有个临时的空间来存放这些中间结果，所以，这就是 <code>temp</code> 表的作用，存放临时的 <code>vocabulary</code>，最后再把 <code>temp</code> 做一次相同的处理，然后把结果写入到 <code>vocabulary</code> 就行</p> <p>当然，对于 <code>vocabulary2</code> 来说，过程差不多，只不过有两个需要注意的点，第一个注意点是值只加一，因为我们算的是篇数，篇数，篇数，重要的东西说三遍~ 无论你的<code>freqs</code>值为多少，在我这里都只算你出现的篇数加1</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 读取词汇, 词汇在某篇新闻中的频次</span>
select word<span class="token punctuation">,</span> freqs from article_word_origin
<span class="token comment">// 遍历结果集</span>
<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>哈希表包含当前词汇<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 获取已有频次</span>
    frequency <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>word<span class="token punctuation">)</span>
    <span class="token comment">// 增加当前频次</span>
    map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>word<span class="token punctuation">,</span> frequency <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果不包含则新建</span>
    map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>word<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>第二个注意点是最后对temp的处理是相同的，即最后执行的是汇总操作，所以要采用 <code>vocabulary</code> 的算法</p> <h3 id="_4、生成两个表"><a href="#_4、生成两个表" class="header-anchor">#</a> 4、生成两个表</h3> <p>在 <code>process</code> 包下新建 <code>GenerateTempVocabularyTest</code> 类</p> <p>主要的逻辑：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
  <span class="token comment">// 生成vocabulary表</span>
  <span class="token function">generateVocabulary</span><span class="token punctuation">(</span><span class="token string">&quot;vocabulary&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">clearTempTable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 生成vocabulary2表</span>
  <span class="token function">generateVocabulary</span><span class="token punctuation">(</span><span class="token string">&quot;vocabulary2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">clearTempTable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// 关闭连接</span>
  <span class="token class-name">DatabaseUtil</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> connection<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>先看一下 <code>clearTempTable</code> 方法，用于在插入 <code>vocabulary</code> 后清空 <code>temp</code> 表，<code>truncate table temp</code> 是截断表的语句，截断比清空更彻底，仅保留表结构，会把自动递增的数值归零，当然这里为了好理解我就直接叫清空，大家注意一下即可</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 清空临时表
 */</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">clearTempTable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;开始清空temp表...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> sql <span class="token operator">=</span> <span class="token string">&quot;truncate table temp&quot;</span><span class="token punctuation">;</span>
    ps <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">prepareStatement</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ps<span class="token punctuation">.</span><span class="token function">executeUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;清空temp表完成...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>接下来是生成词汇表的主要逻辑，当然啦，为了简洁亿点，我把一些打印语句去掉了，但是源码是有的</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 生成词汇表
 */</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">generateVocabulary</span><span class="token punctuation">(</span><span class="token class-name">String</span> tableName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>

    <span class="token comment">// 初始化一些全局变量</span>
    <span class="token function">initGlobalVariables</span><span class="token punctuation">(</span>tableName<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 循环执行 &quot;查询ArticleWord表-&gt;计算生成词汇表-&gt;插入到词汇表&quot;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> n <span class="token operator">&lt;</span> times<span class="token punctuation">;</span> n<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 主要逻辑：生成和插入</span>
        <span class="token function">calculateAndInsertIntoVocabulary</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 关闭结果集和PreparedStatement，释放资源，但是连接可以留着，因为连接没必要重复创建</span>
        <span class="token class-name">DatabaseUtil</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span>rs<span class="token punctuation">,</span> ps<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>计算和插入词汇表：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 计算和插入词汇表
 */</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">calculateAndInsertIntoVocabulary</span><span class="token punctuation">(</span><span class="token keyword">int</span> time<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{</span>
    <span class="token comment">// 查询article_word_origin的word，freqs的语句</span>
    <span class="token class-name">String</span> sql <span class="token operator">=</span> <span class="token string">&quot;select word, freqs from article_word_origin limit &quot;</span> <span class="token operator">+</span> time <span class="token operator">*</span> size <span class="token operator">+</span> <span class="token string">&quot;, &quot;</span> <span class="token operator">+</span> size<span class="token punctuation">;</span>
    <span class="token comment">// 如果是循环最后一次则意味着是temp -&gt; vocabulary，要把语句改一下</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>time <span class="token operator">==</span> times <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sql <span class="token operator">=</span> <span class="token string">&quot;select word, freqs from temp limit 0, 10000000&quot;</span><span class="token punctuation">;</span>
        sqlPrefix <span class="token operator">=</span> <span class="token string">&quot;insert delayed into &quot;</span> <span class="token operator">+</span> table <span class="token operator">+</span> <span class="token string">&quot;(word, freqs) values &quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    ps <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">prepareStatement</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span>
    rs <span class="token operator">=</span> ps<span class="token punctuation">.</span><span class="token function">executeQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 计算生成词汇表</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> vocabularyMap <span class="token operator">=</span> <span class="token function">generateVocabularyMap</span><span class="token punctuation">(</span>rs<span class="token punctuation">,</span> table<span class="token punctuation">,</span> time<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token class-name">StringBuilder</span> sqlSuffix <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  	<span class="token comment">// 构造插入语句后缀</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> entry <span class="token operator">:</span> vocabularyMap<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        i<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> suffix <span class="token operator">=</span> <span class="token string">&quot;( '&quot;</span> <span class="token operator">+</span> entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;', &quot;</span> <span class="token operator">+</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;),&quot;</span><span class="token punctuation">;</span>
        sqlSuffix<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>suffix<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">%</span> <span class="token number">1000</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 循环1000次执行一次插入</span>
            <span class="token function">insertIntoVocabulary</span><span class="token punctuation">(</span>sqlPrefix<span class="token punctuation">,</span> sqlSuffix<span class="token punctuation">)</span><span class="token punctuation">;</span>
            sqlSuffix <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 最后也要执行一次插入 </span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sqlSuffix<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">insertIntoVocabulary</span><span class="token punctuation">(</span>sqlPrefix<span class="token punctuation">,</span> sqlSuffix<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><p>计算生成词汇表：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 根据表名选择对应算法生成词汇表Map
 */</span>
<span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> <span class="token function">generateVocabularyMap</span><span class="token punctuation">(</span><span class="token class-name">ResultSet</span> rs<span class="token punctuation">,</span> <span class="token class-name">String</span> table<span class="token punctuation">,</span> <span class="token keyword">int</span> time<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;vocabulary&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>table<span class="token punctuation">)</span> <span class="token operator">||</span> time <span class="token operator">==</span> times <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 这里time == times - 1作用是最后一次循环temp表生成`vocabulary2`时采用生成Vocabulary的词汇表Map的算法</span>
    <span class="token keyword">return</span> <span class="token function">generateVocabularyMap1</span><span class="token punctuation">(</span>rs<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">generateVocabularyMap2</span><span class="token punctuation">(</span>rs<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
	* 生成Vocabulary的词汇表Map
	*/</span>
<span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> <span class="token function">generateVocabularyMap1</span><span class="token punctuation">(</span><span class="token class-name">ResultSet</span> rs<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{</span>
  <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> resultMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>rs<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> word <span class="token operator">=</span> rs<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> frequency <span class="token operator">=</span> rs<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>resultMap<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>word<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      resultMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>word<span class="token punctuation">,</span> resultMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>word<span class="token punctuation">)</span> <span class="token operator">+</span> frequency<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      resultMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>word<span class="token punctuation">,</span> frequency<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> resultMap<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
	* 生成Vocabulary2的词汇表Map
	*/</span>
<span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> <span class="token function">generateVocabularyMap2</span><span class="token punctuation">(</span><span class="token class-name">ResultSet</span> rs<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{</span>
  <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> resultMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>rs<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> word <span class="token operator">=</span> rs<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>resultMap<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>word<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      resultMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>word<span class="token punctuation">,</span> resultMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>word<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      resultMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>word<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> resultMap<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br></div></div><p>插入到词汇表：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/** * 插入到词汇表 */</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">insertIntoVocabulary</span><span class="token punctuation">(</span><span class="token class-name">String</span> sqlPrefix<span class="token punctuation">,</span> <span class="token class-name">StringBuilder</span> sqlSuffix<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{</span>    
  <span class="token class-name">String</span> insertSql <span class="token operator">=</span> sqlPrefix <span class="token operator">+</span> sqlSuffix<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> sqlSuffix<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
  ps<span class="token punctuation">.</span><span class="token function">addBatch</span><span class="token punctuation">(</span>insertSql<span class="token punctuation">)</span><span class="token punctuation">;</span>    
  ps<span class="token punctuation">.</span><span class="token function">executeBatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>初始化全局变量：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/** 
	* 数据库连接 
	*/</span>
<span class="token keyword">private</span> <span class="token class-name">Connection</span> connection<span class="token punctuation">;</span>
<span class="token comment">/** 
	* PreparedStatement 
	*/</span>
<span class="token keyword">private</span> <span class="token class-name">PreparedStatement</span> ps<span class="token punctuation">;</span>
<span class="token comment">/** 
	* 结果集 
	*/</span>
<span class="token keyword">private</span> <span class="token class-name">ResultSet</span> rs<span class="token punctuation">;</span>
<span class="token comment">/** 
	* 表名 
	*/</span>
<span class="token keyword">private</span> <span class="token class-name">String</span> table<span class="token punctuation">;</span>
<span class="token comment">/** 
	* 插入语句前缀 
	*/</span>
<span class="token keyword">private</span> <span class="token class-name">String</span> sqlPrefix<span class="token punctuation">;</span>
<span class="token comment">/** 
	* 每次要查询多少条 
	*/</span>
<span class="token keyword">private</span> <span class="token keyword">int</span> size<span class="token punctuation">;</span>
<span class="token comment">/** 
	* 总共要查多少次 
	*/</span>
<span class="token keyword">private</span> <span class="token keyword">int</span> times<span class="token punctuation">;</span>
<span class="token comment">/** 
	* 初始化全局变量 
	*/</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initGlobalVariables</span><span class="token punctuation">(</span><span class="token class-name">String</span> tableName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>    
    connection <span class="token operator">=</span> <span class="token class-name">DatabaseUtil</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
    table <span class="token operator">=</span> tableName<span class="token punctuation">;</span>    
    sqlPrefix <span class="token operator">=</span> <span class="token string">&quot;insert delayed into temp(word, freqs) values &quot;</span><span class="token punctuation">;</span>    
    <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">118893080</span><span class="token punctuation">;</span> <span class="token comment">// article_word_origin的数据条数    </span>
    size <span class="token operator">=</span> <span class="token number">10000000</span><span class="token punctuation">;</span> <span class="token comment">// 默认一千万    </span>
    times <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span>count <span class="token operator">/</span> <span class="token punctuation">(</span>size <span class="token operator">*</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">// 要循环的次数，加一是最后一次temp到vocabulary</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><p>注意：导入前要配置一些全局变量，比如 <code>article_word_origin</code>的数据条数，这部分可以提取到配置文件里面，但是就让你们自行升级吧</p> <p>完整代码：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>example<span class="token punctuation">.</span>process</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>example<span class="token punctuation">.</span>utils<span class="token punctuation">.</span></span><span class="token class-name">DatabaseUtil</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span></span><span class="token class-name">Test</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">Connection</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">PreparedStatement</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">ResultSet</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">SQLException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashMap</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 3、生成两个词汇表
 * （词汇-词汇在语料库出现的总次数）
 *
 * @author Jack
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GenerateTempVocabularyTest</span> <span class="token punctuation">{</span>

  <span class="token comment">/**
  	* 数据库连接
  	*/</span>
  <span class="token keyword">private</span> <span class="token class-name">Connection</span> connection<span class="token punctuation">;</span>
  <span class="token comment">/**
  	* PreparedStatement
  	*/</span>
  <span class="token keyword">private</span> <span class="token class-name">PreparedStatement</span> ps<span class="token punctuation">;</span>
  <span class="token comment">/**
  	* 结果集
  	*/</span>
  <span class="token keyword">private</span> <span class="token class-name">ResultSet</span> rs<span class="token punctuation">;</span>
  <span class="token comment">/**
  	* 表名
  	*/</span>
  <span class="token keyword">private</span> <span class="token class-name">String</span> table<span class="token punctuation">;</span>
  <span class="token comment">/*
  	* 插入语句前缀
  	*/</span>
  <span class="token keyword">private</span> <span class="token class-name">String</span> sqlPrefix<span class="token punctuation">;</span>
  <span class="token comment">/**
  	* 每次要查询多少条
  	*/</span>
  <span class="token keyword">private</span> <span class="token keyword">int</span> size<span class="token punctuation">;</span>
  <span class="token comment">/**
  	* 总共要查多少次
  	*/</span>
  <span class="token keyword">private</span> <span class="token keyword">int</span> times<span class="token punctuation">;</span>

  <span class="token comment">/**
  	* 初始化全局变量
  	*/</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initGlobalVariables</span><span class="token punctuation">(</span><span class="token class-name">String</span> tableName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    connection <span class="token operator">=</span> <span class="token class-name">DatabaseUtil</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    table <span class="token operator">=</span> tableName<span class="token punctuation">;</span>
    sqlPrefix <span class="token operator">=</span> <span class="token string">&quot;insert delayed into temp(word, freqs) values &quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">118893080</span><span class="token punctuation">;</span>
    size <span class="token operator">=</span> <span class="token number">10000000</span><span class="token punctuation">;</span>
    times <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span>count <span class="token operator">/</span> <span class="token punctuation">(</span>size <span class="token operator">*</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
  	* 生成Vocabulary的词汇表Map
  	*/</span>
  <span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> <span class="token function">generateVocabularyMap1</span><span class="token punctuation">(</span><span class="token class-name">ResultSet</span> rs<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> resultMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>rs<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">String</span> word <span class="token operator">=</span> rs<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">int</span> frequency <span class="token operator">=</span> rs<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>resultMap<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>word<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        resultMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>word<span class="token punctuation">,</span> resultMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>word<span class="token punctuation">)</span> <span class="token operator">+</span> frequency<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        resultMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>word<span class="token punctuation">,</span> frequency<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> resultMap<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
  	* 生成Vocabulary2的词汇表Map
  	*/</span>
  <span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> <span class="token function">generateVocabularyMap2</span><span class="token punctuation">(</span><span class="token class-name">ResultSet</span> rs<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> resultMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>rs<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">String</span> word <span class="token operator">=</span> rs<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>resultMap<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>word<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        resultMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>word<span class="token punctuation">,</span> resultMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>word<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        resultMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>word<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> resultMap<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
  	* 根据表名选择对应算法生成词汇表Map
  	*/</span>
  <span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> <span class="token function">generateVocabularyMap</span><span class="token punctuation">(</span><span class="token class-name">ResultSet</span> rs<span class="token punctuation">,</span> <span class="token class-name">String</span> table<span class="token punctuation">,</span> <span class="token keyword">int</span> time<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;vocabulary&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>table<span class="token punctuation">)</span> <span class="token operator">||</span> time <span class="token operator">==</span> times <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">generateVocabularyMap1</span><span class="token punctuation">(</span>rs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">generateVocabularyMap2</span><span class="token punctuation">(</span>rs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
  	* 插入到词汇表
  	*/</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">insertIntoVocabulary</span><span class="token punctuation">(</span><span class="token class-name">String</span> sqlPrefix<span class="token punctuation">,</span> <span class="token class-name">StringBuilder</span> sqlSuffix<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> insertSql <span class="token operator">=</span> sqlPrefix <span class="token operator">+</span> sqlSuffix<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> sqlSuffix<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ps<span class="token punctuation">.</span><span class="token function">addBatch</span><span class="token punctuation">(</span>insertSql<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ps<span class="token punctuation">.</span><span class="token function">executeBatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
  	* 计算和插入词汇表
  	*/</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">calculateAndInsertIntoVocabulary</span><span class="token punctuation">(</span><span class="token keyword">int</span> time<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> sql <span class="token operator">=</span> <span class="token string">&quot;select word, freqs from article_word_origin limit &quot;</span> <span class="token operator">+</span> time <span class="token operator">*</span> size <span class="token operator">+</span> <span class="token string">&quot;, &quot;</span> <span class="token operator">+</span> size<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>time <span class="token operator">==</span> times <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;正在从temp表生成&quot;</span> <span class="token operator">+</span> table <span class="token operator">+</span> <span class="token string">&quot;表...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      sql <span class="token operator">=</span> <span class="token string">&quot;select word, freqs from temp limit 0, 10000000&quot;</span><span class="token punctuation">;</span>
      sqlPrefix <span class="token operator">=</span> <span class="token string">&quot;insert delayed into &quot;</span> <span class="token operator">+</span> table <span class="token operator">+</span> <span class="token string">&quot;(word, freqs) values &quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    ps <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">prepareStatement</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span>
    rs <span class="token operator">=</span> ps<span class="token punctuation">.</span><span class="token function">executeQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> vocabularyMap <span class="token operator">=</span> <span class="token function">generateVocabularyMap</span><span class="token punctuation">(</span>rs<span class="token punctuation">,</span> table<span class="token punctuation">,</span> time<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token class-name">StringBuilder</span> sqlSuffix <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> entry <span class="token operator">:</span> vocabularyMap<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      i<span class="token operator">++</span><span class="token punctuation">;</span>
      <span class="token class-name">String</span> suffix <span class="token operator">=</span> <span class="token string">&quot;( '&quot;</span> <span class="token operator">+</span> entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;', &quot;</span> <span class="token operator">+</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;),&quot;</span><span class="token punctuation">;</span>
      sqlSuffix<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>suffix<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">%</span> <span class="token number">1000</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">insertIntoVocabulary</span><span class="token punctuation">(</span>sqlPrefix<span class="token punctuation">,</span> sqlSuffix<span class="token punctuation">)</span><span class="token punctuation">;</span>
        sqlSuffix <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sqlSuffix<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">insertIntoVocabulary</span><span class="token punctuation">(</span>sqlPrefix<span class="token punctuation">,</span> sqlSuffix<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
  	* 生成词汇表
  	*/</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">generateVocabulary</span><span class="token punctuation">(</span><span class="token class-name">String</span> tableName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;开始计时...正在生成辅助生成&quot;</span> <span class="token operator">+</span> tableName <span class="token operator">+</span> <span class="token string">&quot;表的temp表...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> startApplication <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 初始化一些全局变量</span>
    <span class="token function">initGlobalVariables</span><span class="token punctuation">(</span>tableName<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 循环执行 &quot;查询ArticleWord表-&gt;计算生成词汇表-&gt;插入到词汇表&quot;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> n <span class="token operator">&lt;</span> times<span class="token punctuation">;</span> n<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;</span> times <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;开始读取和处理第&quot;</span> <span class="token operator">+</span> n <span class="token operator">*</span> <span class="token number">10000000</span> <span class="token operator">+</span> <span class="token string">&quot;条到第&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>n <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">10000000</span> <span class="token operator">+</span> <span class="token string">&quot;数据...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">long</span> startProcess <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">calculateAndInsertIntoVocabulary</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">DatabaseUtil</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span>rs<span class="token punctuation">,</span> ps<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;耗时&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startProcess<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;毫秒&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;计时结束...总计耗时&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startApplication<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;毫秒&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
  	* 清空临时表
  	*/</span>
  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">clearTempTable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;开始清空temp表...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> sql <span class="token operator">=</span> <span class="token string">&quot;truncate table temp&quot;</span><span class="token punctuation">;</span>
    ps <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">prepareStatement</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ps<span class="token punctuation">.</span><span class="token function">executeUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;清空temp表完成...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Test</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token comment">// 生成vocabulary表</span>
    <span class="token function">generateVocabulary</span><span class="token punctuation">(</span><span class="token string">&quot;vocabulary&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">clearTempTable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 生成vocabulary2表</span>
    <span class="token function">generateVocabulary</span><span class="token punctuation">(</span><span class="token string">&quot;vocabulary2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">clearTempTable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 关闭连接</span>
    <span class="token class-name">DatabaseUtil</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> connection<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br></div></div><p>大概10分多钟左右就运行完了</p> <h3 id="_5、导入article-word"><a href="#_5、导入article-word" class="header-anchor">#</a> 5、导入<code>article_word</code></h3> <p>OK，接下来就是导入<code>article_word</code>表了，逻辑之前我们已经写过，只需在基础上稍微改造一下，增加 <code>tfidf</code> 和 <code>bayes</code> 两个字段的计算和插入即可</p> <p>如果不明白可以选中两个文件用 <code>IDEA</code> 进行对比</p> <p>首先是增加全局变量，其中文章的分词列表本来是内联的，现在为了方便计算 <code>tfidf</code> 和 <code>bayes</code> 把它们提取出来成为全局变量</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/** 
	* 文章的分词列表 
	*/</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SegToken</span><span class="token punctuation">&gt;</span></span> titleTokenList<span class="token punctuation">,</span> contentTokenList<span class="token punctuation">;</span>
<span class="token comment">/** 
	* 两个词汇表 
	*/</span>
<span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> vocabulary<span class="token punctuation">,</span> vocabulary2<span class="token punctuation">;</span>
<span class="token comment">/**	
	* 文档总词项数	
	*/</span>
<span class="token keyword">private</span> <span class="token keyword">int</span> allWordAmount<span class="token punctuation">;</span>
<span class="token comment">/**	
	* 文档总数	
	*/</span>
<span class="token keyword">private</span> <span class="token keyword">int</span> allNewsAmount<span class="token punctuation">;</span>
<span class="token comment">/**	
	* 平均文档长度	
	*/</span>
<span class="token keyword">private</span> <span class="token keyword">double</span> averageNewsWordAmount<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>然后初始化变量增加几个全局变量的初始化：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/** * 1.初始化变量 */</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initGlobalVariables</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>  	
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>		
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>		
  <span class="token comment">// 增加的部分↓    </span>
  <span class="token comment">// 加载两个表到两个map    </span>
  <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;加载两个词汇表...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
  vocabulary <span class="token operator">=</span> <span class="token function">loadVocabulary</span><span class="token punctuation">(</span><span class="token string">&quot;vocabulary&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
  vocabulary2 <span class="token operator">=</span> <span class="token function">loadVocabulary</span><span class="token punctuation">(</span><span class="token string">&quot;vocabulary2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
  <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;加载两个词汇表完成...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
  <span class="token comment">// 初始化文档集总词项数和文档总数和平均文档长度    </span>
  allWordAmount <span class="token operator">=</span> <span class="token number">185544097</span><span class="token punctuation">;</span>    
  allNewsAmount <span class="token operator">=</span> <span class="token number">1298155</span><span class="token punctuation">;</span>    
  averageNewsWordAmount <span class="token operator">=</span> allWordAmount <span class="token operator">/</span> <span class="token punctuation">(</span>allNewsAmount <span class="token operator">*</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>增加的方法：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/** 
	* 1.2 加载词汇表 
	*/</span>
<span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> <span class="token function">loadVocabulary</span><span class="token punctuation">(</span><span class="token class-name">String</span> tableName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{</span>  
  <span class="token class-name">String</span> sql <span class="token operator">=</span> <span class="token string">&quot;select word, freqs from &quot;</span> <span class="token operator">+</span> tableName<span class="token punctuation">;</span>  
  <span class="token class-name">PreparedStatement</span> preparedStatement <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">prepareStatement</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span>  
  <span class="token class-name">ResultSet</span> resultSet <span class="token operator">=</span> preparedStatement<span class="token punctuation">.</span><span class="token function">executeQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
  <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> vocabulary <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
  <span class="token keyword">while</span> <span class="token punctuation">(</span>resultSet<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>   
    vocabulary<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>resultSet<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>resultSet<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
  <span class="token punctuation">}</span> 
  <span class="token class-name">DatabaseUtil</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span>resultSet<span class="token punctuation">,</span> preparedStatement<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
  <span class="token keyword">return</span> vocabulary<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**	
	* 2.1.3.1 计算tfidf	
	*/</span>
<span class="token keyword">public</span> <span class="token keyword">double</span> <span class="token function">calculateTfidf</span><span class="token punctuation">(</span><span class="token keyword">int</span> contentWordFrequency<span class="token punctuation">,</span> <span class="token keyword">int</span> newsLength<span class="token punctuation">,</span> <span class="token class-name">String</span> keyword<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
  <span class="token keyword">int</span> wordAllAmount <span class="token operator">=</span> vocabulary2<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>keyword<span class="token punctuation">)</span><span class="token punctuation">;</span>  
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">10</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> contentWordFrequency<span class="token punctuation">)</span>    <span class="token operator">/</span> <span class="token punctuation">(</span>contentWordFrequency <span class="token operator">+</span> <span class="token number">10</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token number">0.5</span> <span class="token operator">*</span> <span class="token punctuation">(</span>newsLength <span class="token operator">/</span> averageNewsWordAmount <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token operator">*</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>allNewsAmount <span class="token operator">*</span> <span class="token number">1.0</span> <span class="token operator">/</span> <span class="token punctuation">(</span>wordAllAmount <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**	
	* 2.1.3.2 计算贝叶斯	
	*/</span>
<span class="token keyword">public</span> <span class="token keyword">double</span> <span class="token function">calculateBayes</span><span class="token punctuation">(</span><span class="token keyword">int</span> contentWordFrequency<span class="token punctuation">,</span> <span class="token keyword">int</span> newsLength<span class="token punctuation">,</span> <span class="token class-name">String</span> keyword<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
  <span class="token keyword">int</span> wordAllFrequency <span class="token operator">=</span> vocabulary<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>keyword<span class="token punctuation">)</span><span class="token punctuation">;</span>  
  <span class="token keyword">return</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>    
    <span class="token punctuation">(</span>contentWordFrequency <span class="token operator">+</span> <span class="token punctuation">(</span>wordAllFrequency <span class="token operator">*</span> <span class="token number">2000.0</span> <span class="token operator">/</span> allWordAmount<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>newsLength <span class="token operator">+</span> <span class="token number">2000</span><span class="token punctuation">)</span>  
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>修改的方法：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/** * 2.1.3 构建sql后缀 */</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">buildSqlSuffix</span><span class="token punctuation">(</span><span class="token keyword">int</span> newsID<span class="token punctuation">,</span> <span class="token class-name">String</span> keyword<span class="token punctuation">)</span> <span class="token punctuation">{</span>  	
  <span class="token comment">// 原来三行不变    </span>
  <span class="token comment">// int titleWordFrequency = titleFrequencyMap.get(keyword) != null ? titleFrequencyMap.get(keyword) : 0;    </span>
  <span class="token comment">// int contentWordFrequency = contentFrequencyMap.get(keyword) != null ? contentFrequencyMap.get(keyword) : 0;    	// int totalWordFrequency = titleWordFrequency + contentWordFrequency;  	</span>
  <span class="token comment">// 以下为增加的    </span>
  <span class="token keyword">int</span> newsLength <span class="token operator">=</span> contentTokenList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> titleTokenList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
  <span class="token keyword">double</span> tfidf <span class="token operator">=</span> <span class="token function">calculateTfidf</span><span class="token punctuation">(</span>contentWordFrequency<span class="token punctuation">,</span> newsLength<span class="token punctuation">,</span> keyword<span class="token punctuation">)</span><span class="token punctuation">;</span>    
  <span class="token keyword">double</span> bayes <span class="token operator">=</span> <span class="token function">calculateBayes</span><span class="token punctuation">(</span>contentWordFrequency<span class="token punctuation">,</span> newsLength<span class="token punctuation">,</span> keyword<span class="token punctuation">)</span><span class="token punctuation">;</span>    
  <span class="token keyword">return</span> <span class="token string">&quot;(&quot;</span> <span class="token operator">+</span> newsID <span class="token operator">+</span> <span class="token string">&quot;, '&quot;</span> <span class="token operator">+</span> keyword <span class="token operator">+</span> <span class="token string">&quot;', &quot;</span> <span class="token operator">+</span> totalWordFrequency <span class="token operator">+</span> <span class="token string">&quot;, &quot;</span> <span class="token operator">+</span> titleWordFrequency <span class="token operator">+</span> <span class="token string">&quot;, &quot;</span> <span class="token operator">+</span> contentWordFrequency <span class="token operator">+</span> <span class="token string">&quot;, &quot;</span> <span class="token operator">+</span> tfidf <span class="token operator">+</span> <span class="token string">&quot;, &quot;</span> <span class="token operator">+</span> bayes <span class="token operator">+</span> <span class="token string">&quot;),&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>插入语句后缀改一改，增加 <code>tfidf</code> 和 <code>bayes</code> 两个字段：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// before</span>
<span class="token class-name">String</span> sqlPrefix <span class="token operator">=</span> <span class="token string">&quot;INSERT delayed INTO article_word(article_id, word, freqs, freqs_title, freqs_content) VALUES &quot;</span><span class="token punctuation">;</span>
<span class="token comment">// after</span>
<span class="token class-name">String</span> sqlPrefix <span class="token operator">=</span> <span class="token string">&quot;INSERT delayed INTO article_word(article_id, word, freqs, freqs_title, freqs_content, tfidf, bayes) VALUES &quot;</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>完整版：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>example<span class="token punctuation">.</span>process</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>huaban<span class="token punctuation">.</span>analysis<span class="token punctuation">.</span>jieba<span class="token punctuation">.</span></span><span class="token class-name">JiebaSegmenter</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>huaban<span class="token punctuation">.</span>analysis<span class="token punctuation">.</span>jieba<span class="token punctuation">.</span></span><span class="token class-name">SegToken</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>example<span class="token punctuation">.</span>utils<span class="token punctuation">.</span></span><span class="token class-name">DatabaseUtil</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span></span><span class="token class-name">Test</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>charset<span class="token punctuation">.</span></span><span class="token class-name">StandardCharsets</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">Connection</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">PreparedStatement</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">ResultSet</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">SQLException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 4、分词生成article_word（带tfidf和bayes）
 * 注意：my.ini文件的[mysqld]中最后加入：bulk_insert_buffer_size=100M，
 * 修改max_allowed_packet=100M，然后重启服务
 *
 * @author Jack
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ImportArticleWordWithTfidfBayesTest</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * PreparedStatement
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">PreparedStatement</span> preparedStatement<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 数据库连接
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Connection</span> connection<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 新闻的分词频率表
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> titleFrequencyMap<span class="token punctuation">,</span> contentFrequencyMap<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 文章的分词列表
     */</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SegToken</span><span class="token punctuation">&gt;</span></span> titleTokenList<span class="token punctuation">,</span> contentTokenList<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 两个词汇表
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> vocabulary<span class="token punctuation">,</span> vocabulary2<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 获取新闻xml的文件读取流
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">BufferedReader</span> bufferReader<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 停用词集合
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> stopWordsSet<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 结巴分词器
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">JiebaSegmenter</span> jiebaSegmenter<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 插入语句后缀
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">StringBuilder</span> suffix<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 文档总词项数
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> allWordAmount<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 文档总数
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> allNewsAmount<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 平均文档长度
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">double</span> averageNewsWordAmount<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 1.初始化变量
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initGlobalVariables</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token comment">// 获取数据库连接和preparedStatement</span>
        connection <span class="token operator">=</span> <span class="token class-name">DatabaseUtil</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        preparedStatement <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">prepareStatement</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 加载停用词</span>
        stopWordsSet <span class="token operator">=</span> <span class="token function">loadStopWords</span><span class="token punctuation">(</span><span class="token class-name">ImportArticleWordWithTfidfBayesTest</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResourceAsStream</span><span class="token punctuation">(</span><span class="token string">&quot;stop_words.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 初始化结巴分词器和插入语句后缀</span>
        jiebaSegmenter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JiebaSegmenter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        suffix <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 获取新闻文件输入流</span>
        <span class="token class-name">String</span> filePath <span class="token operator">=</span> <span class="token string">&quot;F:\\news_data\\news_transform_data.dat&quot;</span><span class="token punctuation">;</span>
        bufferReader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedReader</span><span class="token punctuation">(</span>
                <span class="token keyword">new</span> <span class="token class-name">InputStreamReader</span><span class="token punctuation">(</span>
                        <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span>UTF_8
                <span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 加载两个表到两个map</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;加载两个词汇表...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        vocabulary <span class="token operator">=</span> <span class="token function">loadVocabulary</span><span class="token punctuation">(</span><span class="token string">&quot;vocabulary&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        vocabulary2 <span class="token operator">=</span> <span class="token function">loadVocabulary</span><span class="token punctuation">(</span><span class="token string">&quot;vocabulary2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;加载两个词汇表完成...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 初始化文档集总词项数和文档总数和平均文档长度</span>
        allWordAmount <span class="token operator">=</span> <span class="token number">185544097</span><span class="token punctuation">;</span>
        allNewsAmount <span class="token operator">=</span> <span class="token number">1298155</span><span class="token punctuation">;</span>
        averageNewsWordAmount <span class="token operator">=</span> allWordAmount <span class="token operator">/</span> <span class="token punctuation">(</span>allNewsAmount <span class="token operator">*</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 1.1 加载停用词，方法来自结巴分词源码
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">loadStopWords</span><span class="token punctuation">(</span><span class="token class-name">InputStream</span> in<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> set <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">BufferedReader</span> buff<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            buff <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedReader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InputStreamReader</span><span class="token punctuation">(</span>in<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> line<span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>line <span class="token operator">=</span> buff<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                set<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>line<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                buff<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> set<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 1.2 加载词汇表
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> <span class="token function">loadVocabulary</span><span class="token punctuation">(</span><span class="token class-name">String</span> tableName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> sql <span class="token operator">=</span> <span class="token string">&quot;select word, freqs from &quot;</span> <span class="token operator">+</span> tableName<span class="token punctuation">;</span>
        <span class="token class-name">PreparedStatement</span> preparedStatement <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">prepareStatement</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ResultSet</span> resultSet <span class="token operator">=</span> preparedStatement<span class="token punctuation">.</span><span class="token function">executeQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> vocabulary <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>resultSet<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            vocabulary<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>resultSet<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>resultSet<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">DatabaseUtil</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span>resultSet<span class="token punctuation">,</span> preparedStatement<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> vocabulary<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token comment">/**
     * 2.导入ArticleWord
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">importArticleWord</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// row代表第几行，newsAmount代表现在是第几篇新闻</span>
        <span class="token keyword">int</span> lineNumber <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> newsID <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token comment">// 存放标题和内容</span>
        <span class="token class-name">String</span> title <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> content<span class="token punctuation">;</span>
        <span class="token comment">// 存储每行的内容</span>
        <span class="token class-name">String</span> line <span class="token operator">=</span> bufferReader<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 开始读取新闻</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>line <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            lineNumber<span class="token operator">++</span><span class="token punctuation">;</span> <span class="token comment">// 行数自增</span>
            <span class="token comment">// 单数行title，放到title变量</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>lineNumber <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                title <span class="token operator">=</span> line<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 双数行content，和title组成一篇新闻，开始处理</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>lineNumber <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                content <span class="token operator">=</span> line<span class="token punctuation">;</span>
                <span class="token comment">// 新闻篇数自增</span>
                newsID<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token comment">// 生成和拼接后缀</span>
                suffix <span class="token operator">=</span> <span class="token function">generateSuffix</span><span class="token punctuation">(</span>newsID<span class="token punctuation">,</span> title<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 遍历完每1000篇新闻（2000行）执行一次插入</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>newsID <span class="token operator">%</span> <span class="token number">1000</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> suffix<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">insertArticleWord</span><span class="token punctuation">(</span>suffix<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;插入完&quot;</span> <span class="token operator">+</span> newsID <span class="token operator">+</span> <span class="token string">&quot;篇文章...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// 重新初始化插入语句后缀</span>
                    suffix <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 读取下一行</span>
            line <span class="token operator">=</span> bufferReader<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 最后的还剩不足1000条也要插入</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>suffix<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">insertArticleWord</span><span class="token punctuation">(</span>suffix<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 2.1 生成插入语句后缀
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">StringBuilder</span> <span class="token function">generateSuffix</span><span class="token punctuation">(</span><span class="token keyword">int</span> newsID<span class="token punctuation">,</span> <span class="token class-name">String</span> newsTitle<span class="token punctuation">,</span> <span class="token class-name">String</span> newContent<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment">// 新闻标题和内容分别分词</span>
        titleTokenList <span class="token operator">=</span> <span class="token function">separateWords</span><span class="token punctuation">(</span>newsTitle<span class="token punctuation">)</span><span class="token punctuation">;</span>
        contentTokenList <span class="token operator">=</span> <span class="token function">separateWords</span><span class="token punctuation">(</span>newContent<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 计算标题和内容词汇的频率</span>
        titleFrequencyMap <span class="token operator">=</span> <span class="token function">calculateWordFrequency</span><span class="token punctuation">(</span>stopWordsSet<span class="token punctuation">,</span> titleTokenList<span class="token punctuation">)</span><span class="token punctuation">;</span>
        contentFrequencyMap <span class="token operator">=</span> <span class="token function">calculateWordFrequency</span><span class="token punctuation">(</span>stopWordsSet<span class="token punctuation">,</span> contentTokenList<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 遍历内容的词汇-频率表</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> entry <span class="token operator">:</span> contentFrequencyMap<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            suffix<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token function">buildSqlSuffix</span><span class="token punctuation">(</span>newsID<span class="token punctuation">,</span> entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            titleFrequencyMap<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 遍历标题的词汇-频率表</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> entry <span class="token operator">:</span> titleFrequencyMap<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            suffix<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token function">buildSqlSuffix</span><span class="token punctuation">(</span>newsID<span class="token punctuation">,</span> entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> suffix<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 2.1.1 分词
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SegToken</span><span class="token punctuation">&gt;</span></span> <span class="token function">separateWords</span><span class="token punctuation">(</span><span class="token class-name">String</span> words<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> jiebaSegmenter<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>words<span class="token punctuation">,</span> <span class="token class-name">JiebaSegmenter<span class="token punctuation">.</span>SegMode</span><span class="token punctuation">.</span>SEARCH<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 2.1.2 计算词汇列表里每个词汇出现的频率
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> <span class="token function">calculateWordFrequency</span><span class="token punctuation">(</span><span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> stopWordsSet<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SegToken</span><span class="token punctuation">&gt;</span></span> segTokenList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> frequency <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SegToken</span> segToken <span class="token operator">:</span> segTokenList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>stopWordsSet<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>segToken<span class="token punctuation">.</span>word<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> segToken<span class="token punctuation">.</span>word<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>frequency<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>segToken<span class="token punctuation">.</span>word<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    frequency<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>segToken<span class="token punctuation">.</span>word<span class="token punctuation">,</span> frequency<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>segToken<span class="token punctuation">.</span>word<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    frequency<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>segToken<span class="token punctuation">.</span>word<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> frequency<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 2.1.3 构建sql后缀
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">buildSqlSuffix</span><span class="token punctuation">(</span><span class="token keyword">int</span> newsID<span class="token punctuation">,</span> <span class="token class-name">String</span> keyword<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> titleWordFrequency <span class="token operator">=</span> titleFrequencyMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>keyword<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> titleFrequencyMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>keyword<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> contentWordFrequency <span class="token operator">=</span> contentFrequencyMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>keyword<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> contentFrequencyMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>keyword<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> totalWordFrequency <span class="token operator">=</span> titleWordFrequency <span class="token operator">+</span> contentWordFrequency<span class="token punctuation">;</span>
        <span class="token keyword">int</span> newsLength <span class="token operator">=</span> contentTokenList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> titleTokenList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">double</span> tfidf <span class="token operator">=</span> <span class="token function">calculateTfidf</span><span class="token punctuation">(</span>contentWordFrequency<span class="token punctuation">,</span> newsLength<span class="token punctuation">,</span> keyword<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">double</span> bayes <span class="token operator">=</span> <span class="token function">calculateBayes</span><span class="token punctuation">(</span>contentWordFrequency<span class="token punctuation">,</span> newsLength<span class="token punctuation">,</span> keyword<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">&quot;(&quot;</span> <span class="token operator">+</span> newsID <span class="token operator">+</span> <span class="token string">&quot;, '&quot;</span> <span class="token operator">+</span> keyword <span class="token operator">+</span> <span class="token string">&quot;', &quot;</span> <span class="token operator">+</span> totalWordFrequency <span class="token operator">+</span> <span class="token string">&quot;, &quot;</span> <span class="token operator">+</span> titleWordFrequency <span class="token operator">+</span> <span class="token string">&quot;, &quot;</span> <span class="token operator">+</span> contentWordFrequency <span class="token operator">+</span> <span class="token string">&quot;, &quot;</span> <span class="token operator">+</span> tfidf <span class="token operator">+</span> <span class="token string">&quot;, &quot;</span> <span class="token operator">+</span> bayes <span class="token operator">+</span> <span class="token string">&quot;),&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 2.1.3.1 计算tfidf
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">double</span> <span class="token function">calculateTfidf</span><span class="token punctuation">(</span><span class="token keyword">int</span> contentWordFrequency<span class="token punctuation">,</span> <span class="token keyword">int</span> newsLength<span class="token punctuation">,</span> <span class="token class-name">String</span> keyword<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> wordAllAmount <span class="token operator">=</span> vocabulary2<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>keyword<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">10</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> contentWordFrequency<span class="token punctuation">)</span>
                <span class="token operator">/</span> <span class="token punctuation">(</span>contentWordFrequency <span class="token operator">+</span> <span class="token number">10</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token number">0.5</span> <span class="token operator">*</span> <span class="token punctuation">(</span>newsLength <span class="token operator">/</span> averageNewsWordAmount <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token operator">*</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>allNewsAmount <span class="token operator">*</span> <span class="token number">1.0</span> <span class="token operator">/</span> <span class="token punctuation">(</span>wordAllAmount <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 2.1.3.2 计算贝叶斯
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">double</span> <span class="token function">calculateBayes</span><span class="token punctuation">(</span><span class="token keyword">int</span> contentWordFrequency<span class="token punctuation">,</span> <span class="token keyword">int</span> newsLength<span class="token punctuation">,</span> <span class="token class-name">String</span> keyword<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> wordAllFrequency <span class="token operator">=</span> vocabulary<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>keyword<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
                <span class="token punctuation">(</span>contentWordFrequency <span class="token operator">+</span> <span class="token punctuation">(</span>wordAllFrequency <span class="token operator">*</span> <span class="token number">2000.0</span> <span class="token operator">/</span> allWordAmount<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>newsLength <span class="token operator">+</span> <span class="token number">2000</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token comment">/**
     * 2.2 插入ArticleWord到数据库
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">insertArticleWord</span><span class="token punctuation">(</span><span class="token class-name">StringBuilder</span> sqlSuffix<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> sqlPrefix <span class="token operator">=</span> <span class="token string">&quot;INSERT delayed INTO article_word(article_id, word, freqs, freqs_title, freqs_content, tfidf, bayes) VALUES &quot;</span><span class="token punctuation">;</span>
        <span class="token comment">// substring是因为最后一个','要去掉 values(),(),(), -&gt; values(),(),()</span>
        <span class="token class-name">String</span> sql <span class="token operator">=</span> sqlPrefix <span class="token operator">+</span> sqlSuffix<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> sqlSuffix<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        preparedStatement<span class="token punctuation">.</span><span class="token function">addBatch</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span>
        preparedStatement<span class="token punctuation">.</span><span class="token function">executeBatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;开始计时...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> start <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 初始化一些全局变量</span>
        <span class="token function">initGlobalVariables</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 导入ArticleWord</span>
        <span class="token function">importArticleWord</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 关闭数据库的连接</span>
        <span class="token class-name">DatabaseUtil</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> preparedStatement<span class="token punctuation">,</span> connection<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;计时结束...总共耗时&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;毫秒&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br><span class="line-number">224</span><br><span class="line-number">225</span><br><span class="line-number">226</span><br><span class="line-number">227</span><br><span class="line-number">228</span><br><span class="line-number">229</span><br><span class="line-number">230</span><br><span class="line-number">231</span><br><span class="line-number">232</span><br><span class="line-number">233</span><br><span class="line-number">234</span><br><span class="line-number">235</span><br><span class="line-number">236</span><br><span class="line-number">237</span><br><span class="line-number">238</span><br><span class="line-number">239</span><br><span class="line-number">240</span><br><span class="line-number">241</span><br><span class="line-number">242</span><br><span class="line-number">243</span><br><span class="line-number">244</span><br><span class="line-number">245</span><br><span class="line-number">246</span><br><span class="line-number">247</span><br><span class="line-number">248</span><br><span class="line-number">249</span><br><span class="line-number">250</span><br><span class="line-number">251</span><br><span class="line-number">252</span><br><span class="line-number">253</span><br><span class="line-number">254</span><br><span class="line-number">255</span><br><span class="line-number">256</span><br><span class="line-number">257</span><br><span class="line-number">258</span><br><span class="line-number">259</span><br><span class="line-number">260</span><br><span class="line-number">261</span><br><span class="line-number">262</span><br><span class="line-number">263</span><br><span class="line-number">264</span><br><span class="line-number">265</span><br><span class="line-number">266</span><br><span class="line-number">267</span><br><span class="line-number">268</span><br><span class="line-number">269</span><br><span class="line-number">270</span><br><span class="line-number">271</span><br><span class="line-number">272</span><br><span class="line-number">273</span><br><span class="line-number">274</span><br><span class="line-number">275</span><br><span class="line-number">276</span><br><span class="line-number">277</span><br><span class="line-number">278</span><br><span class="line-number">279</span><br><span class="line-number">280</span><br><span class="line-number">281</span><br><span class="line-number">282</span><br><span class="line-number">283</span><br><span class="line-number">284</span><br><span class="line-number">285</span><br><span class="line-number">286</span><br><span class="line-number">287</span><br><span class="line-number">288</span><br><span class="line-number">289</span><br><span class="line-number">290</span><br><span class="line-number">291</span><br><span class="line-number">292</span><br><span class="line-number">293</span><br><span class="line-number">294</span><br><span class="line-number">295</span><br><span class="line-number">296</span><br><span class="line-number">297</span><br><span class="line-number">298</span><br><span class="line-number">299</span><br><span class="line-number">300</span><br><span class="line-number">301</span><br><span class="line-number">302</span><br><span class="line-number">303</span><br><span class="line-number">304</span><br><span class="line-number">305</span><br><span class="line-number">306</span><br><span class="line-number">307</span><br><span class="line-number">308</span><br></div></div><p>测试运行：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>开始计时...
main dict load finished, time elapsed 1038 ms
model load finished, time elapsed 54 ms.
加载两个词汇表...
加载两个词汇表完成...
插入完1000篇文章...
插入完2000篇文章...
插入完3000篇文章...
...
插入完1296000篇文章...
插入完1297000篇文章...
插入完1298000篇文章...
计时结束...总共耗时1560687毫秒
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>耗时26分钟1秒，还阔以啊这速度😊~</p> <img src="https://img-blog.csdnimg.cn/5f1c2882625842099926daa9eade39f8.png" alt="在这里插入图片描述" style="zoom:80%;">
当然，其实速度还能更快，比如把文件拆分成几块，然后开多个程序运行每个块，这样速度可以提高到10几分钟，但是`article_word` 表里新闻的顺序会被打乱，不过，这并不影响后续使用，强迫症请绕道😒，关于这种方法，大家自行尝试~
<h2 id="_2、更新-newsdemoweb-项目"><a href="#_2、更新-newsdemoweb-项目" class="header-anchor">#</a> 2、更新 <code>NewsDemoWeb</code> 项目</h2> <p>有了 <code>tfidf</code> 和 <code>bayes</code> 我们就可以对自定义分词查询进行升级了</p> <p>当然，我们先分析一下查询语句</p> <h3 id="_1、分析查询语句"><a href="#_1、分析查询语句" class="header-anchor">#</a> 1、分析查询语句</h3> <p>我们的任务是根据关键词查询，然后再根据 <code>tfidf</code> 或者 <code>bayes</code> 升降排序，然后要返回 <code>article_id</code>，还要进行分页，所以语句大概长这样</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">select</span> article_id <span class="token keyword">from</span> article_word <span class="token keyword">where</span> word <span class="token operator">=</span> <span class="token string">'美女'</span> <span class="token keyword">order</span> <span class="token keyword">by</span> tfidf <span class="token keyword">desc</span> <span class="token keyword">limit</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">10</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>不过，在没有索引的情况下，查询这条语句耗时很久，所以我们必须建索引</p> <p>由于我们总共用了三个字段，所以我们要新建索引中，根据最左匹配原则和覆盖索引原则，我们应该建包含这三列的复合索引，当然啦，我们要分别给 <code>tfidf</code> 和 <code>bayes</code> 建，因为它们不会同时在查询语句中出现</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">create</span> <span class="token keyword">index</span> index_tfidf <span class="token keyword">on</span> <span class="token punctuation">`</span>article_word<span class="token punctuation">`</span><span class="token punctuation">(</span><span class="token punctuation">`</span>word<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>tfidf<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>article_id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">create</span> <span class="token keyword">index</span> index_bayes <span class="token keyword">on</span> <span class="token punctuation">`</span>article_word<span class="token punctuation">`</span><span class="token punctuation">(</span><span class="token punctuation">`</span>word<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>bayes<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>article_id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>然后有了 <code>article_id</code> 后我们可以根据 <code>article_id</code> 回 <code>article</code> 表查询</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> article <span class="token keyword">where</span> id <span class="token operator">in</span> <span class="token punctuation">(</span>id1<span class="token punctuation">,</span> id2<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>当然啦，如果用这种 <code>in</code> 范围查询的话，不能一次性查询太多，不然也不是很快</p> <h3 id="_2、编写dao"><a href="#_2、编写dao" class="header-anchor">#</a> 2、编写<code>DAO</code></h3> <p>首先在 <code>ArticleDao</code> 把之前的 <code>getListByCustom</code> 删除掉，以及在 <code>ArticleDaoTest</code> 中把它的测试类删除，因为这是旧的自定义查询，我们不希望它占用我们的名字，当然，<code>ArticleCustomServlet</code> 里面的逻辑也要清空，但是框架可以留着</p> <p>然后回来编写 <code>DAO</code></p> <p>首先根据关键词获取基于 <code>tfidf</code> 或 <code>bayes</code> 排序后的新闻 <code>id</code> ，然后根据 <code>id</code> 列表回 <code>article</code> 查询新闻，这里分为两个方法分别执行相应的逻辑</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
	* 根据关键词获取基于tfidf或bayes排序后的新闻id列表
	*
	* @param word 关键词
	* @param pageNumber 页码
	* @param pageSize 页的大小
	* @param orderBy 排序字段，tfidf或bayes
	* @param order 升降序
	* @return 新闻id列表
	*/</span>
<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token function">getIdListByCustom</span><span class="token punctuation">(</span><span class="token class-name">String</span> word<span class="token punctuation">,</span> <span class="token keyword">int</span> pageNumber<span class="token punctuation">,</span> <span class="token keyword">int</span> pageSize<span class="token punctuation">,</span> <span class="token class-name">OrderBy</span> orderBy<span class="token punctuation">,</span> <span class="token class-name">Order</span> order<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{</span>
  <span class="token class-name">String</span> sql <span class="token operator">=</span> <span class="token string">&quot;select article_id from `article_word` where word = '&quot;</span> <span class="token operator">+</span> word
    <span class="token operator">+</span> <span class="token string">&quot;' order by &quot;</span> <span class="token operator">+</span> orderBy <span class="token operator">+</span> <span class="token string">&quot; &quot;</span> <span class="token operator">+</span> order
    <span class="token operator">+</span> <span class="token string">&quot; limit &quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pageNumber <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> pageSize<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;, &quot;</span> <span class="token operator">+</span> pageSize<span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    connection <span class="token operator">=</span> <span class="token class-name">DatabaseUtil</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ps <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">prepareStatement</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span>
    resultSet <span class="token operator">=</span> ps<span class="token punctuation">.</span><span class="token function">executeQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> articleIDList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>resultSet<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      articleIDList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>resultSet<span class="token punctuation">.</span><span class="token function">getLong</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> articleIDList<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
    <span class="token class-name">DatabaseUtil</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span>resultSet<span class="token punctuation">,</span> ps<span class="token punctuation">,</span> connection<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
	* 自定义分词查询，并且根据tfidf或贝叶斯进行排序
	*
	* @param word 关键词
	* @param pageNumber 页码
	* @param pageSize 页的大小
	* @param orderBy 排序字段，tfidf或bayes
	* @param order 升降序	
	* @return 分词查询结果
	*/</span>
<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ArticleVo</span><span class="token punctuation">&gt;</span></span> <span class="token function">getListByCustom</span><span class="token punctuation">(</span><span class="token class-name">String</span> word<span class="token punctuation">,</span> <span class="token keyword">int</span> pageNumber<span class="token punctuation">,</span> <span class="token keyword">int</span> pageSize<span class="token punctuation">,</span> <span class="token class-name">OrderBy</span> orderBy<span class="token punctuation">,</span> <span class="token class-name">Order</span> order<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
  <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">IDList</span> <span class="token operator">=</span> <span class="token function">getIdListByCustom</span><span class="token punctuation">(</span>word<span class="token punctuation">,</span> pageNumber<span class="token punctuation">,</span> pageSize<span class="token punctuation">,</span> orderBy<span class="token punctuation">,</span> order<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">StringBuilder</span> suffix <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token string">&quot;(&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Long</span> id <span class="token operator">:</span> <span class="token class-name">IDList</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    suffix<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;, &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  suffix <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span>suffix<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> suffix<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">String</span> sql <span class="token operator">=</span> <span class="token string">&quot;select * from article where id in&quot;</span> <span class="token operator">+</span> suffix<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">selectList</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br></div></div><p>编写测试类：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
	* 测试自定义分词查询，并且根据tfidf或贝叶斯进行排序
	*/</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testGetListByCustom</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
  <span class="token class-name">ArticleDao</span> articleDao <span class="token operator">=</span> <span class="token class-name">ArticleDao</span><span class="token punctuation">.</span><span class="token function">getArticleDao</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>articleDao<span class="token punctuation">.</span><span class="token function">getListByCustom</span><span class="token punctuation">(</span><span class="token string">&quot;河源&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token class-name">OrderBy</span><span class="token punctuation">.</span>tfidf<span class="token punctuation">,</span> <span class="token class-name">Order</span><span class="token punctuation">.</span>DESC<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>articleDao<span class="token punctuation">.</span><span class="token function">getListByCustom</span><span class="token punctuation">(</span><span class="token string">&quot;河源&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token class-name">OrderBy</span><span class="token punctuation">.</span>bayes<span class="token punctuation">,</span> <span class="token class-name">Order</span><span class="token punctuation">.</span>ASC<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>当然啦，这里面用了两个枚举类 <code>Order</code>和 <code>OrderBy</code>，在项目包下新建 <code>enumeration</code> 包，包下新建这两个类即可</p> <p>为什么要用枚举，主要是因为排序字段 <code>OrderBy</code> 和排序方式 <code>order</code> 都是只有两个选项，所以用枚举比较方便</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>enumeration</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">Order</span> <span class="token punctuation">{</span>
    ASC<span class="token punctuation">,</span> DESC
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>enumeration</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">OrderBy</span> <span class="token punctuation">{</span>
    tfidf<span class="token punctuation">,</span> bayes
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>然后就是 <code>servlet</code> 了，<code>servlet</code> 包下修改 <code>ArticleCustomServlet</code> 类为</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>servlet</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>dao<span class="token punctuation">.</span></span><span class="token class-name">ArticleDao</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>enumeration<span class="token punctuation">.</span></span><span class="token class-name">Order</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>enumeration<span class="token punctuation">.</span></span><span class="token class-name">OrderBy</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>utils<span class="token punctuation">.</span></span><span class="token class-name">GsonUtil</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>utils<span class="token punctuation">.</span></span><span class="token class-name">LruCache</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>vo<span class="token punctuation">.</span></span><span class="token class-name">ArticleVo</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>gson<span class="token punctuation">.</span></span><span class="token class-name">Gson</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">WebServlet</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServlet</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletResponse</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">PrintWriter</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Locale</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@WebServlet</span><span class="token punctuation">(</span><span class="token string">&quot;/article-custom&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ArticleCustomServlet</span> <span class="token keyword">extends</span> <span class="token class-name">HttpServlet</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">LruCache</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">ArticleVo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> cache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LruCache</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doGet</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token function">doPost</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doPost</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        response<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token string">&quot;application/json;charset=utf8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> word <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">&quot;word&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> pageNumber <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">&quot;pageNumber&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> pageSize <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">&quot;pageSize&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Order</span> order <span class="token operator">=</span> <span class="token class-name">Order</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">&quot;order&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token class-name">Locale</span><span class="token punctuation">.</span>ROOT<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">OrderBy</span> orderBy <span class="token operator">=</span> <span class="token class-name">OrderBy</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">&quot;orderBy&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token class-name">Locale</span><span class="token punctuation">.</span>ROOT<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Gson</span> gson <span class="token operator">=</span> <span class="token class-name">GsonUtil</span><span class="token punctuation">.</span><span class="token function">getGson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">PrintWriter</span> out <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> cacheKey <span class="token operator">=</span> word <span class="token operator">+</span> <span class="token string">&quot;@&quot;</span> <span class="token operator">+</span> pageNumber <span class="token operator">+</span> <span class="token string">&quot;@&quot;</span> <span class="token operator">+</span>pageSize <span class="token operator">+</span> <span class="token string">&quot;@&quot;</span> <span class="token operator">+</span> orderBy <span class="token operator">+</span> <span class="token string">&quot;@&quot;</span> <span class="token operator">+</span> order<span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;走缓存...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>gson<span class="token punctuation">.</span><span class="token function">toJson</span><span class="token punctuation">(</span>cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            out<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            out<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token class-name">ArticleDao</span> articleDao <span class="token operator">=</span> <span class="token class-name">ArticleDao</span><span class="token punctuation">.</span><span class="token function">getArticleDao</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ArticleVo</span><span class="token punctuation">&gt;</span></span> articleListByWord <span class="token operator">=</span> articleDao<span class="token punctuation">.</span><span class="token function">getListByCustom</span><span class="token punctuation">(</span>word<span class="token punctuation">,</span> pageNumber<span class="token punctuation">,</span> pageSize<span class="token punctuation">,</span> orderBy<span class="token punctuation">,</span> order<span class="token punctuation">)</span><span class="token punctuation">;</span>
                cache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">,</span> articleListByWord<span class="token punctuation">)</span><span class="token punctuation">;</span>
                out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>gson<span class="token punctuation">.</span><span class="token function">toJson</span><span class="token punctuation">(</span>articleListByWord<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                out<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                out<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br></div></div><p>启动服务器，打开浏览器测试，效果正常~</p> <p>刷新多几遍，检查一下控制台，发现缓存也有走，不过我们现在是缓存每次查询的，并不仅仅只缓存第一页，有此需求的自行改造吧~</p> <p>当然，接下来还需要解决分词查询（多个关键词或者句子分词查询）的问题，不过其实也并不难实现，只需在当前基础上先加个分词处理成分词列表，然后对每个单词进行上面的查询，然后汇总即可，不过要是想的这么简单你就错了，因为一篇文章可能包含多个关键词，用户输入的多个关键词肯定就是希望搜索出的新闻里面尽可能含有他提供的关键词，所以算法要重新设计，下面提供一种思路：</p> <p>以 <code>tfidf</code> 为例子，<code>bayes</code> 类似</p> <p>首先，先对查询句子进行分词得到关键词列表</p> <p>然后，根据关键词找出 <code>article_id</code>，<code>tfidf</code>，<code>word</code></p> <p>计算每个 <code>article_id</code> 对应的权重，权重 += 每个关键词 <code>word</code> 在查询句子中出现的次数 ÷ 3 × 与 <code>article_id</code>对应的关键词的<code>tfidf</code>，然后根据权重对 <code>article_id</code> 进行排序，筛选出前n条结果</p> <p>“每个关键词在查询句子中出现的次数”是什么意思？</p> <blockquote><p>举个栗子，搜索 <code>张三要富婆，李四要富婆，王五也要富婆</code> 这个句子，关键词 <code>富婆</code> 出现了三次，所以它在查询句子中出现的次数就为3，根据关键词重复的次数可以推断用户更想搜索这个关键词，所以我们给出这种提高关键词权重的方法，除以3是为了减弱它的影响，因为如果出现的次数太多，会导致这个值太大影响最终结果所以除以3，这个值可以根据实验自行调整</p> <p>当然，由于我们分词后的结果去除掉很多停用词，所以不用担心因为重复很多无关紧要的语气词之类的而导致它们的权重被提高，不过其实不加权重也没关系，最主要的排序依据还是某篇新闻是否尽可能多地出现用户提供的关键词</p></blockquote> <p>根据前n条结果的 <code>article_id</code> 回 <code>article</code> 表查询，获得新闻结果</p> <h2 id="_3、开发分页"><a href="#_3、开发分页" class="header-anchor">#</a> 3、开发分页</h2> <p>在开发前端之前，我们需要再完善一下后端的分页的功能</p> <p>还没分页的方法：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 根据关键词模糊查询新闻
 *
 * @param word 关键词
 * @return 与关键词匹配的文章
 */</span>
<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ArticleVo</span><span class="token punctuation">&gt;</span></span> <span class="token function">getArticleListByWord</span><span class="token punctuation">(</span><span class="token class-name">String</span> word<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> sql <span class="token operator">=</span> <span class="token string">&quot;select * from article where title like '%&quot;</span> <span class="token operator">+</span> word <span class="token operator">+</span> <span class="token string">&quot;%' or content like '%&quot;</span> <span class="token operator">+</span> word <span class="token operator">+</span> <span class="token string">&quot;%'&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">selectList</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 基于全文索引的查询
 *
 * @param word 关键词
 * @return 查询结果
 */</span>
<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ArticleVo</span><span class="token punctuation">&gt;</span></span> <span class="token function">getListByWordWithFulltext</span><span class="token punctuation">(</span><span class="token class-name">String</span> word<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> sql <span class="token operator">=</span> <span class="token string">&quot;SELECT * FROM article WHERE MATCH (title, content) AGAINST ('&quot;</span> <span class="token operator">+</span> word <span class="token operator">+</span> <span class="token string">&quot;')&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">selectList</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>很简单，加几个参数，改一下语句即可。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 根据关键词模糊查询新闻
 *
 * @param word 关键词
 * @return 与关键词匹配的文章
 */</span>
<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ArticleVo</span><span class="token punctuation">&gt;</span></span> <span class="token function">getArticleListByWord</span><span class="token punctuation">(</span><span class="token class-name">String</span> word<span class="token punctuation">,</span> <span class="token keyword">int</span> pageNumber<span class="token punctuation">,</span> <span class="token keyword">int</span> pageSize<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> sql <span class="token operator">=</span> <span class="token string">&quot;select * from article where title like '%&quot;</span> <span class="token operator">+</span> word <span class="token operator">+</span> <span class="token string">&quot;%' or content like '%&quot;</span> <span class="token operator">+</span> word <span class="token operator">+</span> <span class="token string">&quot;%' &quot;</span><span class="token operator">+</span>
            <span class="token string">&quot;limit &quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pageNumber <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> pageSize<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;, &quot;</span> <span class="token operator">+</span> pageSize<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">selectList</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 基于全文索引的查询
 *
 * @param word 关键词
 * @return 查询结果
 */</span>
<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ArticleVo</span><span class="token punctuation">&gt;</span></span> <span class="token function">getListByWordWithFulltext</span><span class="token punctuation">(</span><span class="token class-name">String</span> word<span class="token punctuation">,</span> <span class="token keyword">int</span> pageNumber<span class="token punctuation">,</span> <span class="token keyword">int</span> pageSize<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> sql <span class="token operator">=</span> <span class="token string">&quot;SELECT * FROM article WHERE MATCH (title, content) AGAINST ('&quot;</span> <span class="token operator">+</span> word <span class="token operator">+</span> <span class="token string">&quot;') &quot;</span><span class="token operator">+</span>
            <span class="token string">&quot;limit &quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pageNumber <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> pageSize<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;, &quot;</span> <span class="token operator">+</span> pageSize<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">selectList</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>此外，由于模糊查询方法的名字 <code>getArticleListByWord</code> 不是很让人明白这个方法是模糊查询，所以我们把方法的名字修改为 <code>getArticleListByFuzzy</code>，同时测试类名、引用的地方、<code>ArticleSearchServlet</code> 也要改，对于引用这个方法的地方，在 <code>IDEA</code> 里面，我们可以选中这个单词，然后按快捷键 <code>SHIFT + F6</code>，就可以改名，引用这个方法的地方也会全部改名</p> <p>然后，<code>ArticleSearchServlet</code> 改为<code>ArticleFuzzyServlet</code> 后，<code>WebServlet</code> 注解里面的 <code>value</code> 改为 <code>article-fuzzy</code>，即修改 <code>url</code> 匹配的路径</p> <p>注意：大家一定要仔细修改，不能遗漏任何一处~ 如果觉得麻烦也可以不改~</p> <p>现在我们的分页还差一个关键参数，就是结果总数，因为我们在查询的时候已经用了<code>limit</code>，所以我们不知道总的结果有几条，同时不知道有多少页，但是前端是需要这两个参数的，因此，我们可以引入 <code>pagehelper</code> 分页助手，只不过在这里，我并不打算依赖太多东西，还是尽量以自己实现的方式，因为插件是有学习成本的，对于基础不是很好的同学可能不是很友好，所以我这里打算自己实现我们的需求~</p> <p>其实解决方法也很简单，就是我们再查一次数据库，不过这次我们查的是<code>count(*)</code>，也就是结果条数，然后根据页的大小我们自己计算有多少页即可~</p> <p>由于查询结果条数的方法是通用的，所以在 <code>ArticleDao</code> 下新增方法：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 查询结果数通用方法
 *
 * @param sql 查询语句
 * @return 结果数
 */</span>
<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">selectCount</span><span class="token punctuation">(</span><span class="token class-name">String</span> sql<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        connection <span class="token operator">=</span> <span class="token class-name">DatabaseUtil</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ps <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">prepareStatement</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span>
        resultSet <span class="token operator">=</span> ps<span class="token punctuation">.</span><span class="token function">executeQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>resultSet<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> resultSet<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token class-name">DatabaseUtil</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span>resultSet<span class="token punctuation">,</span> ps<span class="token punctuation">,</span> connection<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>然后编写三个查询结果数的方法，对应三个业务：模糊查询、全文索引和自定义分词</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 获取模糊查询结果条数
 *
 * @param word 关键词
 * @return 模糊查询结果条数
 */</span>
<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getArticleListCountByFuzzy</span><span class="token punctuation">(</span><span class="token class-name">String</span> word<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> sql <span class="token operator">=</span> <span class="token string">&quot;select count(*) from article where title like '%&quot;</span> <span class="token operator">+</span> word <span class="token operator">+</span> <span class="token string">&quot;%' or content like '%&quot;</span> <span class="token operator">+</span> word <span class="token operator">+</span> <span class="token string">&quot;%'&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">selectCount</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 获取全文索引查询结果条数
 * @param word 关键词
 * @return 全文索引查询结果条数
 */</span>
<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getListCountByWordWithFulltext</span><span class="token punctuation">(</span><span class="token class-name">String</span> word<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> sql <span class="token operator">=</span> <span class="token string">&quot;SELECT * FROM article WHERE MATCH (title, content) AGAINST ('&quot;</span> <span class="token operator">+</span> word <span class="token operator">+</span> <span class="token string">&quot;')&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">selectCount</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 获取自定义分词查询结果条数
 * @param word 关键词
 * @param orderBy 排序字段，tfidf或bayes
 * @param order 升降序
 * @return 自定义分词查询结果条数
 */</span>
<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getListCountByWordCustom</span><span class="token punctuation">(</span><span class="token class-name">String</span> word<span class="token punctuation">,</span> <span class="token class-name">OrderBy</span> orderBy<span class="token punctuation">,</span> <span class="token class-name">Order</span> order<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> sql <span class="token operator">=</span> <span class="token string">&quot;select article_id from `article_word` where word = '&quot;</span> <span class="token operator">+</span> word
            <span class="token operator">+</span> <span class="token string">&quot;' order by &quot;</span> <span class="token operator">+</span> orderBy <span class="token operator">+</span> <span class="token string">&quot; &quot;</span> <span class="token operator">+</span> order<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">selectCount</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p>在 <code>ArticleDaoTest</code> 编写测试：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 测试获取结果数
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testGetListCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token class-name">ArticleDao</span> articleDao <span class="token operator">=</span> <span class="token class-name">ArticleDao</span><span class="token punctuation">.</span><span class="token function">getArticleDao</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>articleDao<span class="token punctuation">.</span><span class="token function">getListCountByWordCustom</span><span class="token punctuation">(</span><span class="token string">&quot;河源&quot;</span><span class="token punctuation">,</span> <span class="token class-name">OrderBy</span><span class="token punctuation">.</span>tfidf<span class="token punctuation">,</span> <span class="token class-name">Order</span><span class="token punctuation">.</span>DESC<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>articleDao<span class="token punctuation">.</span><span class="token function">getListCountByWordWithFulltext</span><span class="token punctuation">(</span><span class="token string">&quot;河源&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>articleDao<span class="token punctuation">.</span><span class="token function">getArticleListCountByFuzzy</span><span class="token punctuation">(</span><span class="token string">&quot;河源&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>结果：</p> <blockquote><p>362950
731826
587</p></blockquote> <p>由于还要存能分多少页，所以 <code>SearchResultVo</code> 也要改进一下，增加分页数量 <code>pages</code>：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>vo</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SearchResultVo</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> <span class="token keyword">long</span> duration<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">int</span> size<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">int</span> pages<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ArticleVo</span><span class="token punctuation">&gt;</span></span> list<span class="token punctuation">;</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">&quot;SearchResultVo{&quot;</span> <span class="token operator">+</span>
      <span class="token string">&quot;duration=&quot;</span> <span class="token operator">+</span> duration <span class="token operator">+</span>
      <span class="token string">&quot;, size=&quot;</span> <span class="token operator">+</span> size <span class="token operator">+</span>
      <span class="token string">&quot;, pages=&quot;</span> <span class="token operator">+</span> pages <span class="token operator">+</span>
      <span class="token string">&quot;, list=&quot;</span> <span class="token operator">+</span> list <span class="token operator">+</span>
      <span class="token string">'}'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token class-name">SearchResultVo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token class-name">SearchResultVo</span><span class="token punctuation">(</span><span class="token keyword">long</span> duration<span class="token punctuation">,</span> <span class="token keyword">int</span> size<span class="token punctuation">,</span> <span class="token keyword">int</span> pages<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ArticleVo</span><span class="token punctuation">&gt;</span></span> list<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>duration <span class="token operator">=</span> duration<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>size <span class="token operator">=</span> size<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>pages <span class="token operator">=</span> pages<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>list <span class="token operator">=</span> list<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">getDuration</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> duration<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setDuration</span><span class="token punctuation">(</span><span class="token keyword">long</span> duration<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>duration <span class="token operator">=</span> duration<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> size<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setSize</span><span class="token punctuation">(</span><span class="token keyword">int</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>size <span class="token operator">=</span> size<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getPages</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> pages<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setPages</span><span class="token punctuation">(</span><span class="token keyword">int</span> pages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>pages <span class="token operator">=</span> pages<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ArticleVo</span><span class="token punctuation">&gt;</span></span> <span class="token function">getList</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> list<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setList</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ArticleVo</span><span class="token punctuation">&gt;</span></span> list<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>list <span class="token operator">=</span> list<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br></div></div><p>接下来就是改造 <code>servlet</code> 了：</p> <p>由于现在返回的数据应该采用 <code>SearchResultVo</code>，方便前端展示搜索信息，所以我们把查询结果封装到一个方法里面</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 获取搜索结果</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getSearchResult</span><span class="token punctuation">(</span><span class="token class-name">String</span> word<span class="token punctuation">,</span> <span class="token keyword">int</span> pageNumber<span class="token punctuation">,</span> <span class="token keyword">int</span> pageSize<span class="token punctuation">,</span> <span class="token class-name">OrderBy</span> orderBy<span class="token punctuation">,</span> <span class="token class-name">Order</span> order<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token comment">// 计算开始时间</span>
    <span class="token keyword">long</span> start <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Gson</span> gson <span class="token operator">=</span> <span class="token class-name">GsonUtil</span><span class="token punctuation">.</span><span class="token function">getGson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  	<span class="token class-name">ArticleDao</span> articleDao <span class="token operator">=</span> <span class="token class-name">ArticleDao</span><span class="token punctuation">.</span><span class="token function">getArticleDao</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 获取自定义查询结果</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ArticleVo</span><span class="token punctuation">&gt;</span></span> articleVoList <span class="token operator">=</span> articleDao<span class="token punctuation">.</span><span class="token function">getListByCustom</span><span class="token punctuation">(</span>word<span class="token punctuation">,</span> pageNumber<span class="token punctuation">,</span> pageSize<span class="token punctuation">,</span> orderBy<span class="token punctuation">,</span> order<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 结果总数</span>
    <span class="token keyword">int</span> resultSize <span class="token operator">=</span> articleDao<span class="token punctuation">.</span><span class="token function">getListCountByWordCustom</span><span class="token punctuation">(</span>word<span class="token punctuation">,</span> orderBy<span class="token punctuation">,</span> order<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 计算能分多少页</span>
    <span class="token keyword">int</span> pages <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span>resultSize <span class="token operator">*</span> <span class="token number">1.0</span> <span class="token operator">/</span> pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 结束时间</span>
    <span class="token keyword">long</span> duration <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">;</span>
    <span class="token comment">// 返回SearchResultVo</span>
    <span class="token keyword">return</span> gson<span class="token punctuation">.</span><span class="token function">toJson</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SearchResultVo</span><span class="token punctuation">(</span>duration<span class="token punctuation">,</span> resultSize <span class="token punctuation">,</span> pages <span class="token punctuation">,</span> articleVoList<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doPost</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    response<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token string">&quot;application/json;charset=utf8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> word <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">&quot;word&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> pageNumber <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">&quot;pageNumber&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> pageSize <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">&quot;pageSize&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Order</span> order <span class="token operator">=</span> <span class="token class-name">Order</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">&quot;order&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token class-name">Locale</span><span class="token punctuation">.</span>ROOT<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">OrderBy</span> orderBy <span class="token operator">=</span> <span class="token class-name">OrderBy</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">&quot;orderBy&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token class-name">Locale</span><span class="token punctuation">.</span>ROOT<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">PrintWriter</span> out <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> cacheKey <span class="token operator">=</span> word <span class="token operator">+</span> <span class="token string">&quot;@&quot;</span> <span class="token operator">+</span> pageNumber <span class="token operator">+</span> <span class="token string">&quot;@&quot;</span> <span class="token operator">+</span> pageSize <span class="token operator">+</span> <span class="token string">&quot;@&quot;</span> <span class="token operator">+</span> orderBy <span class="token operator">+</span> <span class="token string">&quot;@&quot;</span> <span class="token operator">+</span> order<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;走缓存...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        out<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        out<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> searchResult <span class="token operator">=</span> <span class="token function">getSearchResult</span><span class="token punctuation">(</span>word<span class="token punctuation">,</span> pageNumber<span class="token punctuation">,</span> pageSize<span class="token punctuation">,</span> orderBy<span class="token punctuation">,</span> order<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 这里改了</span>
            cache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">,</span> searchResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
            out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>searchResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            out<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            out<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br></div></div><p>启动服务器，查看结果：</p> <p>http://localhost:8080/demo/article-custom?word=%E6%B2%B3%E6%BA%90&amp;pageNumber=2&amp;pageSize=10&amp;order=desc&amp;orderBy=tfidf</p> <p><img src="https://img-blog.csdnimg.cn/3e91428703b3412898c608e59e151d79.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L20wXzQ2NDkxNTQ5,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p> <p>然后接下来改造全文索引和模糊查询即可：</p> <p>这里直接贴代码就行了，逻辑都差不多：</p> <p><code>ArticleCustomServlet</code> ：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>servlet</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>dao<span class="token punctuation">.</span></span><span class="token class-name">ArticleDao</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>enumeration<span class="token punctuation">.</span></span><span class="token class-name">Order</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>enumeration<span class="token punctuation">.</span></span><span class="token class-name">OrderBy</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>utils<span class="token punctuation">.</span></span><span class="token class-name">GsonUtil</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>utils<span class="token punctuation">.</span></span><span class="token class-name">LruCache</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>vo<span class="token punctuation">.</span></span><span class="token class-name">ArticleVo</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>vo<span class="token punctuation">.</span></span><span class="token class-name">SearchResultVo</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>gson<span class="token punctuation">.</span></span><span class="token class-name">Gson</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">WebServlet</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServlet</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletResponse</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">PrintWriter</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Locale</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@WebServlet</span><span class="token punctuation">(</span><span class="token string">&quot;/article-custom&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ArticleCustomServlet</span> <span class="token keyword">extends</span> <span class="token class-name">HttpServlet</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">LruCache</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> cache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LruCache</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doGet</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token function">doPost</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getSearchResult</span><span class="token punctuation">(</span><span class="token class-name">String</span> word<span class="token punctuation">,</span> <span class="token keyword">int</span> pageNumber<span class="token punctuation">,</span> <span class="token keyword">int</span> pageSize<span class="token punctuation">,</span> <span class="token class-name">OrderBy</span> orderBy<span class="token punctuation">,</span> <span class="token class-name">Order</span> order<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token keyword">long</span> start <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Gson</span> gson <span class="token operator">=</span> <span class="token class-name">GsonUtil</span><span class="token punctuation">.</span><span class="token function">getGson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ArticleDao</span> articleDao <span class="token operator">=</span> <span class="token class-name">ArticleDao</span><span class="token punctuation">.</span><span class="token function">getArticleDao</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ArticleVo</span><span class="token punctuation">&gt;</span></span> articleVoList <span class="token operator">=</span> articleDao<span class="token punctuation">.</span><span class="token function">getListByCustom</span><span class="token punctuation">(</span>word<span class="token punctuation">,</span> pageNumber<span class="token punctuation">,</span> pageSize<span class="token punctuation">,</span> orderBy<span class="token punctuation">,</span> order<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 结果总数</span>
    <span class="token keyword">int</span> resultSize <span class="token operator">=</span> articleDao<span class="token punctuation">.</span><span class="token function">getListCountByWordCustom</span><span class="token punctuation">(</span>word<span class="token punctuation">,</span> orderBy<span class="token punctuation">,</span> order<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 计算能分多少页</span>
    <span class="token keyword">int</span> pages <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span>resultSize <span class="token operator">*</span> <span class="token number">1.0</span> <span class="token operator">/</span> pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> duration <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">;</span>
    <span class="token keyword">return</span> gson<span class="token punctuation">.</span><span class="token function">toJson</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SearchResultVo</span><span class="token punctuation">(</span>duration<span class="token punctuation">,</span> resultSize <span class="token punctuation">,</span> pages <span class="token punctuation">,</span> articleVoList<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doPost</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    response<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token string">&quot;application/json;charset=utf8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> word <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">&quot;word&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> pageNumber <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">&quot;pageNumber&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> pageSize <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">&quot;pageSize&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Order</span> order <span class="token operator">=</span> <span class="token class-name">Order</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">&quot;order&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token class-name">Locale</span><span class="token punctuation">.</span>ROOT<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">OrderBy</span> orderBy <span class="token operator">=</span> <span class="token class-name">OrderBy</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">&quot;orderBy&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token class-name">Locale</span><span class="token punctuation">.</span>ROOT<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">PrintWriter</span> out <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> cacheKey <span class="token operator">=</span> word <span class="token operator">+</span> <span class="token string">&quot;@&quot;</span> <span class="token operator">+</span> pageNumber <span class="token operator">+</span> <span class="token string">&quot;@&quot;</span> <span class="token operator">+</span> pageSize <span class="token operator">+</span> <span class="token string">&quot;@&quot;</span> <span class="token operator">+</span> orderBy <span class="token operator">+</span> <span class="token string">&quot;@&quot;</span> <span class="token operator">+</span> order<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;走缓存...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      out<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      out<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> searchResult <span class="token operator">=</span> <span class="token function">getSearchResult</span><span class="token punctuation">(</span>word<span class="token punctuation">,</span> pageNumber<span class="token punctuation">,</span> pageSize<span class="token punctuation">,</span> orderBy<span class="token punctuation">,</span> order<span class="token punctuation">)</span><span class="token punctuation">;</span>
        cache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">,</span> searchResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
        out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>searchResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        out<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        out<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br></div></div><p><code>ArticleFulltextServlet</code>：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>servlet</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>dao<span class="token punctuation">.</span></span><span class="token class-name">ArticleDao</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>utils<span class="token punctuation">.</span></span><span class="token class-name">GsonUtil</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>vo<span class="token punctuation">.</span></span><span class="token class-name">ArticleVo</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>vo<span class="token punctuation">.</span></span><span class="token class-name">SearchResultVo</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>gson<span class="token punctuation">.</span></span><span class="token class-name">Gson</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">WebServlet</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServlet</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletResponse</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">PrintWriter</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@WebServlet</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/article-fulltext&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ArticleFulltextServlet</span> <span class="token keyword">extends</span> <span class="token class-name">HttpServlet</span> <span class="token punctuation">{</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doGet</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token function">doPost</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getSearchResult</span><span class="token punctuation">(</span><span class="token class-name">String</span> word<span class="token punctuation">,</span> <span class="token keyword">int</span> pageNumber<span class="token punctuation">,</span> <span class="token keyword">int</span> pageSize<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token keyword">long</span> start <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Gson</span> gson <span class="token operator">=</span> <span class="token class-name">GsonUtil</span><span class="token punctuation">.</span><span class="token function">getGson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ArticleDao</span> articleDao <span class="token operator">=</span> <span class="token class-name">ArticleDao</span><span class="token punctuation">.</span><span class="token function">getArticleDao</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ArticleVo</span><span class="token punctuation">&gt;</span></span> articleVoList <span class="token operator">=</span> articleDao<span class="token punctuation">.</span><span class="token function">getListByWordWithFulltext</span><span class="token punctuation">(</span>word<span class="token punctuation">,</span> pageNumber<span class="token punctuation">,</span> pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 结果总数</span>
    <span class="token keyword">int</span> resultSize <span class="token operator">=</span> articleDao<span class="token punctuation">.</span><span class="token function">getListCountByWordWithFulltext</span><span class="token punctuation">(</span>word<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 计算能分多少页</span>
    <span class="token keyword">int</span> pages <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span>resultSize <span class="token operator">*</span> <span class="token number">1.0</span> <span class="token operator">/</span> pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> duration <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">;</span>
    <span class="token keyword">return</span> gson<span class="token punctuation">.</span><span class="token function">toJson</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SearchResultVo</span><span class="token punctuation">(</span>duration<span class="token punctuation">,</span> resultSize <span class="token punctuation">,</span> pages <span class="token punctuation">,</span> articleVoList<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doPost</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    response<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token string">&quot;application/json;charset=utf8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> word <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">&quot;word&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> pageNumber <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">&quot;pageNumber&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> pageSize <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">&quot;pageSize&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">PrintWriter</span> out <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">getSearchResult</span><span class="token punctuation">(</span>word<span class="token punctuation">,</span> pageNumber<span class="token punctuation">,</span> pageSize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
      out<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      out<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br></div></div><p><code>ArticleFuzzyServlet</code>：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>servlet</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>dao<span class="token punctuation">.</span></span><span class="token class-name">ArticleDao</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>utils<span class="token punctuation">.</span></span><span class="token class-name">GsonUtil</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>vo<span class="token punctuation">.</span></span><span class="token class-name">ArticleVo</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>vo<span class="token punctuation">.</span></span><span class="token class-name">SearchResultVo</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>gson<span class="token punctuation">.</span></span><span class="token class-name">Gson</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@WebServlet</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/article-fuzzy&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ArticleFuzzyServlet</span> <span class="token keyword">extends</span> <span class="token class-name">HttpServlet</span> <span class="token punctuation">{</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doGet</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token function">doPost</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getSearchResult</span><span class="token punctuation">(</span><span class="token class-name">String</span> word<span class="token punctuation">,</span> <span class="token keyword">int</span> pageNumber<span class="token punctuation">,</span> <span class="token keyword">int</span> pageSize<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token keyword">long</span> start <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Gson</span> gson <span class="token operator">=</span> <span class="token class-name">GsonUtil</span><span class="token punctuation">.</span><span class="token function">getGson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ArticleDao</span> articleDao <span class="token operator">=</span> <span class="token class-name">ArticleDao</span><span class="token punctuation">.</span><span class="token function">getArticleDao</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ArticleVo</span><span class="token punctuation">&gt;</span></span> articleVoList <span class="token operator">=</span> articleDao<span class="token punctuation">.</span><span class="token function">getArticleListByFuzzy</span><span class="token punctuation">(</span>word<span class="token punctuation">,</span> pageNumber<span class="token punctuation">,</span> pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 结果总数</span>
    <span class="token keyword">int</span> resultSize <span class="token operator">=</span> articleDao<span class="token punctuation">.</span><span class="token function">getArticleListCountByFuzzy</span><span class="token punctuation">(</span>word<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 计算能分多少页</span>
    <span class="token keyword">int</span> pages <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span>resultSize <span class="token operator">*</span> <span class="token number">1.0</span> <span class="token operator">/</span> pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> duration <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">;</span>
    <span class="token keyword">return</span> gson<span class="token punctuation">.</span><span class="token function">toJson</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SearchResultVo</span><span class="token punctuation">(</span>duration<span class="token punctuation">,</span> resultSize <span class="token punctuation">,</span> pages <span class="token punctuation">,</span> articleVoList<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doPost</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    response<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token string">&quot;application/json;charset=utf8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> word <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">&quot;word&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> pageNumber <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">&quot;pageNumber&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> pageSize <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">&quot;pageSize&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">PrintWriter</span> out <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">getSearchResult</span><span class="token punctuation">(</span>word<span class="token punctuation">,</span> pageNumber<span class="token punctuation">,</span> pageSize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
      out<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      out<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br></div></div><p>效果：</p> <p>http://localhost:8080/demo/article-fuzzy?word=%E6%B2%B3%E6%BA%90&amp;pageNumber=2&amp;pageSize=10</p> <p>http://localhost:8080/demo/article-fulltext?word=%E6%B2%B3%E6%BA%90&amp;pageNumber=2&amp;pageSize=10</p> <p>http://localhost:8080/demo/article-custom?word=%E6%B2%B3%E6%BA%90&amp;pageNumber=2&amp;pageSize=10&amp;order=desc&amp;orderBy=tfidf</p> <p><img src="https://img-blog.csdnimg.cn/d769acb52c34447ab8d4edb227ee61d6.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L20wXzQ2NDkxNTQ5,size_16,color_FFFFFF,t_70" alt="请添加图片描述"></p> <p><img src="https://img-blog.csdnimg.cn/7ed770e84cfd4c10895b6025c400219d.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L20wXzQ2NDkxNTQ5,size_16,color_FFFFFF,t_70" alt="请添加图片描述"></p> <p>OK，到这里基本就开发完毕了，当然还是存在一些细节问题，现在的代码仍不够优雅，比如冗余问题还是存在，边界情况还是没考虑，还有很多要考虑的问题，不过我不打算解决，这部分留给你们自行优化~
<img src="https://img-blog.csdnimg.cn/7eb79c0afa6c43bca4faa9e7f10d0941.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L20wXzQ2NDkxNTQ5,size_16,color_FFFFFF,t_70" alt="请添加图片描述"></p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><!----> <span class="next"><a href="/nomoe/develop/04/jquery.html">
        第四讲 检索模型-前端开发-jQuery版
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/nomoe/assets/js/app.b0634cdc.js" defer></script><script src="/nomoe/assets/js/2.e531c252.js" defer></script><script src="/nomoe/assets/js/18.dfbc94c1.js" defer></script>
  </body>
</html>
